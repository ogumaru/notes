<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Notes Blog</title>
        <link>https://notes.ogumaru.dev/</link>
        <description>Notes Blog</description>
        <lastBuildDate>Wed, 19 Apr 2023 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>ja</language>
        <item>
            <title><![CDATA[【Authelia】TraefikとAutheliaを利用してSSOを導入する]]></title>
            <link>https://notes.ogumaru.dev/2023/04/19/introduce-sso-authelia</link>
            <guid>https://notes.ogumaru.dev/2023/04/19/introduce-sso-authelia</guid>
            <pubDate>Wed, 19 Apr 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[概要]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要 への直接リンク" title="概要 への直接リンク">​</a></h2><p>自分用に複数のアプリケーションを稼働させているサーバにおいて、以下に対応するため構成を変更することにした。</p><ol><li>今後は <a href="https://github.com/siyuan-note/siyuan" target="_blank" rel="noopener noreferrer">SiYuan</a> のようなログイン機能を持たないアプリケーションも自分用に安全に公開したい。</li><li>PlantUML は <a href="https://marketplace.visualstudio.com/items?itemName=jebbs.plantuml" target="_blank" rel="noopener noreferrer">VSCode の拡張機能</a>からも利用できるようにベーシック認証を設定したい。</li><li>現状は Shiori, Trilium Notes などそれぞれで別アカウントでのログインが必要なので、シングルサインオン(SSO)に対応したい。</li><li>SSL/TLS 証明書は<code>certbot-renew.timer</code>を利用して各サブドメインごとに更新していたが、<code>*.example.com</code> のようなワイルドカード証明書を取得したい。</li><li>HTTP3 を使ってみたい。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="方針">方針<a href="#方針" class="hash-link" aria-label="方針 への直接リンク" title="方針 への直接リンク">​</a></h2><p>以下の理由から、ルーティングは既存の nginx から Traefik へ変更することにした。</p><ul><li>既存環境が Docker Compose 上に構築されていること。</li><li><a href="https://doc.traefik.io/traefik/https/acme/#dnschallenge" target="_blank" rel="noopener noreferrer">dnsChallenge</a> の指定で DNS-01 チャレンジ によるワイルドカード証明書取得ができること。</li><li><a href="https://doc.traefik.io/traefik/middlewares/http/forwardauth/" target="_blank" rel="noopener noreferrer">fowardauth</a> によりユーザ認証を挟めること。</li><li>試験的ではあるが HTTP3 を有効にできること。 (nginx では自分でビルドが必要)</li></ul><p>ユーザ認証には Keycloak も検討したが、当該インスタンスのディスク容量が少ないことから、よりサイズの小さい Authelia を採用した。</p><p>メモリ使用量については比較ができなかったが、Go の方が少ないだろうという思い込みもある。</p><table><thead><tr><th>項目</th><th>Authelia</th><th>Keycloak</th></tr></thead><tbody><tr><td>Docker イメージサイズ</td><td>小 (約 55MB)</td><td>大(約 450MB)</td></tr><tr><td>実装言語</td><td>Go</td><td>Java</td></tr></tbody></table><p>構成の概要図は以下の通り。</p><p><img loading="lazy" alt="概要図" src="/assets/images/outline-b7dc265bc86b3f3d05b955e7139cdda7.png" title="概要図" width="1349" height="956" class="img_ev3q"></p><p>各アプリケーションの認証方式は以下のようになる。</p><table><thead><tr><th>アプリケーション</th><th>旧構成</th><th>新構成</th></tr></thead><tbody><tr><td>Shiori</td><td>独自認証</td><td>独自認証</td></tr><tr><td>Trilium Notes</td><td>独自認証</td><td>パスワード認証 (SSO)</td></tr><tr><td>PlantUML</td><td>認証なし</td><td>ベーシック認証 (SSO)</td></tr></tbody></table><p>また、Authelia 自身のログインには Web Authn による二段階認証を設定する。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="traefik-の設定">Traefik の設定<a href="#traefik-の設定" class="hash-link" aria-label="Traefik の設定 への直接リンク" title="Traefik の設定 への直接リンク">​</a></h2><p><code>traefik.yml</code> は以下の通りとした。</p><p>検証の際は <code>caServer: https://acme-staging-v02.api.letsencrypt.org/directory</code> を有効にする。</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>traefik.yml</summary><div><div class="collapsibleContent_i85q"><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">global</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">checknewversion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">sendanonymoususage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">experimental</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">http3</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">entryPoints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">web</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># httpsにリダイレクト</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">redirections</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">entrypoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">to</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> webSecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">scheme</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">webSecure</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http3</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">api</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">insecure</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">dashboard</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">providers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/traefik/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">docker</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">exposedByDefault</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">certificatesResolvers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">myresolver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">acme</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">email</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hoge@example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /letsencrypt/acme.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># caServer: https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">dnsChallenge</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">provider</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gandiv5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">resolvers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ns-a.example.com:53"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ns-b.example.com:53"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ns-c.example.com:53"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">keyType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> EC384</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p><code>compose.yaml</code>のコンテナ設定は以下。</p><p>Gandi でドメインを取得しているため、ワイルドカード証明書取得のために <code>GANDIV5_API_KEY</code> を環境変数として渡す。</p><p>ミドルウェアとして指定されている <code>auth@docker</code> は後述の Authelia のコンテナを指している。</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>compose.yaml</summary><div><div class="collapsibleContent_i85q"><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">traefik</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"traefik:v2.9"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> traefik</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"80:80"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"443:443"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">GANDIV5_API_KEY</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"${GANDIV5_API_KEY}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">traefik.enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.api.service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> api@internal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.api.rule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Host(`traefik.example.com`) </span><span class="token important">&amp;&amp;</span><span class="token plain"> PathPrefix(`/api`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.api.entrypoints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> webSecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.api.tls.certresolver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> myresolver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.api.middlewares</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> auth@docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.dashboard.service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dashboard@internal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.dashboard.rule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Host(`traefik.example.com`) </span><span class="token important">&amp;&amp;</span><span class="token plain"> PathPrefix(`/dashboard`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.dashboard.entrypoints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> webSecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.dashboard.tls.certresolver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> myresolver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.dashboard.middlewares</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> strip</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">traefik.http.middlewares.strip-auth.chain.middlewares</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> auth@docker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">dashboard</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">stripprefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">traefik.http.middlewares.dashboard-stripprefix.stripprefix.prefixes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.wildcard-certs.tls.certresolver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> myresolver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      traefik.http.routers.wildcard</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">certs.tls.domains</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.main</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      traefik.http.routers.wildcard</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">certs.tls.domains</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.sans</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*.example.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /var/run/docker.sock</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/var/run/docker.sock</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># rootless-docker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># - //run/user/1000/docker.sock:/var/run/docker.sock:ro</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/traefik/</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/etc/traefik/</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/letsencrypt/</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/letsencrypt/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unless</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">stopped</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><h2 class="anchor anchorWithStickyNavbar_LWe7" id="authelia-の設定">Authelia の設定<a href="#authelia-の設定" class="hash-link" aria-label="Authelia の設定 への直接リンク" title="Authelia の設定 への直接リンク">​</a></h2><p>鍵の値など秘密情報があるが、それらのパラメータは環境変数ではなく <code>secrets</code> に指定して渡す。</p><p>コンテナ側の <code>secrets</code> で利用するものを指定した上で、<code>/run/secrets/</code> 内のファイル名にアクセスすると、ファイルの内容が展開されて参照することができる。</p><blockquote><p>A secret value can be loaded by Authelia when the configuration key ends with one of the following words: key, secret, password, or token.</p></blockquote><p><a href="https://www.authelia.com/configuration/methods/secrets/" target="_blank" rel="noopener noreferrer">Secrets - Configuration - Authelia - (www.authelia.com)</a></p><p><code>compose.yaml</code> の <code>secrets</code> 部分の記述は以下。</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">secrets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">authelia_jwt_secret_file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"${PWD}/secrets/authelia/jwt_secret.txt"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">authelia_session_secret_file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"${PWD}/secrets/authelia/session.secret.txt"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">authelia_storage_encryption_key_file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"${PWD}/secrets/authelia/storate.encryption_key.txt"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>compose.yaml</code> のコンテナの設定は以下。</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>compose.yaml</summary><div><div class="collapsibleContent_i85q"><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">auth</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> authelia/authelia</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4.37</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unless</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">stopped</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"--config"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/config/configuration.yml"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/authelia</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">data/config/</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/config/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">TZ</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Asia/Tokyo"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">AUTHELIA_JWT_SECRET_FILE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/run/secrets/authelia_jwt_secret_file"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">AUTHELIA_SESSION_SECRET_FILE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/run/secrets/authelia_session_secret_file"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/run/secrets/authelia_storage_encryption_key_file"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.auth.rule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Host(`auth.example.com`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.auth.entryPoints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> webSecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.auth.tls.certresolver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> myresolver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.middlewares.auth.forwardAuth.address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//auth</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">9091/api/verify</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">rd=https%3A%2F%2Fauth.example.com%2F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.middlewares.auth.forwardAuth.trustForwardHeader</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.middlewares.auth.forwardAuth.authResponseHeaders</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Remote</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">User</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">Remote</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Groups</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">Remote</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">Remote</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Email</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.middlewares.auth-basic.forwardAuth.address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//auth</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">9091/api/verify</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">auth=basic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.middlewares.auth-basic.forwardAuth.trustForwardHeader</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.middlewares.auth-basic.forwardAuth.authResponseHeaders</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Remote</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">User</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">Remote</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Groups</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">Remote</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">Remote</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Email</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">limits</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">cpus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 250M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">secrets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> authelia_jwt_secret_file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> authelia_session_secret_file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> authelia_storage_encryption_key_file</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p><code>traefik.http.middlewares.auth-basic</code> はベーシック認証のミドルウェア、
<code>traefik.http.middlewares.auth</code> はパスワード認証のミドルウェアとなる。</p><p><code>argon2</code> による認証の場合、ログイン時に負荷が高まるためリソース制限したほうが安定した。</p><p><code>configuration.yml</code> は以下。</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>configuration.yml</summary><div><div class="collapsibleContent_i85q"><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">theme</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> light</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># AUTHELIA_JWT_SECRET_FILE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># jwt_secret: ****</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">default_2fa_method</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> webauthn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9091</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">enable_pprof</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">enable_expvars</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">disable_healthcheck</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">headers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">csp_template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># csp_template: "default-src 'self'; frame-src 'none'; object-src 'none'; style-src 'self' 'unsafe-inline' 'nonce-********'; frame-ancestors 'none'; base-uri 'self'"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">authentication_backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /config/users.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">watch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">search</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">email</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">case_insensitive</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">algorithm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> argon2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">argon2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">variant</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> argon2id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">iterations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">65536</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">parallelism</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">key_length</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">salt_length</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">webauthn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">disable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">display_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Hoge Auth"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">attestation_conveyance_preference</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> indirect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">user_verification</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> preferred</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 60s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">session</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> authelia_session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">same_site</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> strict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># AUTHELIA_SESSION_SECRET_FILE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># secret: ****</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">expiration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 7d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">inactivity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 12h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">remember_me_duration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">access_control</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">default_policy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> deny</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"auth.example.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">policy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> two_factor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"traefik.example.com"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"trilium.example.com"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">policy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> one_factor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">subject</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"group:admin"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"plantuml.example.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">policy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> one_factor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">subject</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"group:admin"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"group:guest"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">local</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /config/db.sqlite3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># encryption_key: ****</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">notifier</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">filesystem</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">filename</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /config/notification.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p><code>argon2</code> のパラメータについては　<a href="https://www.rfc-editor.org/rfc/rfc9106.html" target="_blank" rel="noopener noreferrer">RFC 9106</a> の以下を参考に設定した。</p><blockquote><p>If much less memory is available, a uniformly safe option is Argon2id with t=3 iterations, p=4 lanes, m=2^(16) (64 MiB of RAM), 128-bit salt, and 256-bit tag size. This is the SECOND RECOMMENDED option.</p></blockquote><p>VSCode での PlantUML 利用時、ベーシック認証情報を平文で書く必要があるため、PlantUML 用のゲストユーザ (<code>group:guest</code>) を作成し <code>plantuml.example.com</code> のみ許可するようにした。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="各アプリケーションの設定">各アプリケーションの設定<a href="#各アプリケーションの設定" class="hash-link" aria-label="各アプリケーションの設定 への直接リンク" title="各アプリケーションの設定 への直接リンク">​</a></h2><p>それぞれ利用する認証方式にあったミドルウェアを指定した。</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>compose.yaml</summary><div><div class="collapsibleContent_i85q"><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shiori</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ghcr.io/go</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">shiori/shiori</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v1.5.4</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">6</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">g888e59d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shiori</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"${PWD}/shiori:/shiori"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.shiori.rule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Host(`shiori.example.com`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.shiori.entrypoints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> webSecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.shiori.tls.certresolver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> myresolver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> PUID=1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> PGID=1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unless</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">stopped</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">plantuml</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> plantuml/plantuml</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">jetty</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">v1.2023.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> plantuml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">module=http</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">forwarded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.plantuml.rule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Host(`plantuml.example.com`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.plantuml.entrypoints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> webSecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.plantuml.tls.certresolver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> myresolver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.plantuml.middlewares</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> auth</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">basic@docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unless</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">stopped</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">trilium</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zadam/trilium</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">0.59.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"${PWD}/trilium-data:/home/node/trilium-data"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> USER_UID=1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> USER_GID=1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.trilium.rule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Host(`trilium.example.com`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.trilium.entrypoints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> webSecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.trilium.tls.certresolver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> myresolver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">traefik.http.routers.trilium.middlewares</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> auth@docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unless</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">stopped</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><h3 class="anchor anchorWithStickyNavbar_LWe7" id="独自ログイン機能の無効化">独自ログイン機能の無効化<a href="#独自ログイン機能の無効化" class="hash-link" aria-label="独自ログイン機能の無効化 への直接リンク" title="独自ログイン機能の無効化 への直接リンク">​</a></h3><p>Shiori はログイン機能を無効にできなかったため、Authelia による認証をバイパスする。</p><p>Trilium Notes は <a href="https://github.com/zadam/trilium/wiki/Server-installation#disable-authentication" target="_blank" rel="noopener noreferrer">Disable authentication</a> の通り <code>config.ini</code> で以下設定を行うと可能だった。</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[General]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">noAuthentication=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="不要設定を解除">不要設定を解除<a href="#不要設定を解除" class="hash-link" aria-label="不要設定を解除 への直接リンク" title="不要設定を解除 への直接リンク">​</a></h2><p>従来利用していた SSL/TLS 証明書の自動更新を無効化する。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl disable certbot-renew.timer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Removed symlink /etc/systemd/system/timers.target.wants/certbot-renew.timer.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用感">使用感<a href="#使用感" class="hash-link" aria-label="使用感 への直接リンク" title="使用感 への直接リンク">​</a></h2><p>それ自身が重いため、移行前から PlantUML の利用は安定しなかったが、それ以外については t4g.micro のインスタンス( RAM 512 MB, スワップ 1GB) でも使用感に問題はなかった。</p>]]></content:encoded>
            <category>traefik</category>
            <category>docker</category>
            <category>authelia</category>
        </item>
        <item>
            <title><![CDATA[【YubiKey】PINを間違えたYubiKeyのロックを解除する]]></title>
            <link>https://notes.ogumaru.dev/2023/01/15/unlock-yubikey-with-master-pw</link>
            <guid>https://notes.ogumaru.dev/2023/01/15/unlock-yubikey-with-master-pw</guid>
            <pubDate>Sun, 15 Jan 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[概要]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要 への直接リンク" title="概要 への直接リンク">​</a></h2><p>Git のコミット署名に利用している YubiKey の PIN を 3 回間違えてしまい、ロックされてしまった。</p><p>ロックされた状態で<code>git commit</code>すると下記のエラーとなった。</p><blockquote><p>error: gpg failed to sign the data<br>
<!-- -->error: unable to sign the tag</p></blockquote><p>解除コードを利用してロックの解除を行う。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="環境">環境<a href="#環境" class="hash-link" aria-label="環境 への直接リンク" title="環境 への直接リンク">​</a></h2><table><thead><tr><th>項目</th><th>種類 / バージョン</th></tr></thead><tbody><tr><td>ハードウェアキー</td><td>Yubikey 5 NFC</td></tr><tr><td><code>ykman</code></td><td>YubiKey Manager (ykman) version: 4.0.7</td></tr><tr><td><code>yubico-piv-tool</code></td><td>yubico-piv-tool 2.2.0</td></tr><tr><td><code>gpg</code></td><td>gpg (GnuPG) 2.2.27</td></tr></tbody></table><p>また、<code>git config</code>で下記の設定をしており、コミットに署名するようになっている。</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">commit.gpgsign=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user.signingkey=********</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>主鍵は別途保管し、副鍵から生成した署名鍵を YubiKey に入れて管理している。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="結論">結論<a href="#結論" class="hash-link" aria-label="結論 への直接リンク" title="結論 への直接リンク">​</a></h2><p>YubiKey の持つ機能の内、GPG スマートカードとしての PIN がロックされているため、下記の通り対話的に GPG コマンドを実行して解除する。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gpg --card-edit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>プロンプトが <code>gpg/card</code>になったら<code>admin</code>コマンドで管理コマンドを有効化する。</p><div class="language-gpg codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gpg codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gpg/card&gt; admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Admin commands are allowed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>passwd</code>コマンドで<code>2</code>を選択し、PIN のブロックを解除する。</p><div class="language-gpg codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gpg codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gpg/card&gt; passwd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpg: OpenPGP card no. … detected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 - change PIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2 - unblock PIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3 - change Admin PIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4 - set the Reset Code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Q - quit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Your selection? 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PIN unblocked and new PIN set.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ブロックが解除されたら<code>q</code>を入力し終了する。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前提知識-yubikey-の入力コードについて">前提知識: YubiKey の入力コードについて<a href="#前提知識-yubikey-の入力コードについて" class="hash-link" aria-label="前提知識: YubiKey の入力コードについて への直接リンク" title="前提知識: YubiKey の入力コードについて への直接リンク">​</a></h2><p>YubiKey では以下の入力コードが出てくる</p><p>当初これを正しく認識しておらず、混乱した。</p><table><thead><tr><th>名称</th><th>主な用途</th><th>初期値</th></tr></thead><tbody><tr><td>PIN (User PIN)</td><td>ユーザ認証 (これを間違えてロックされた)</td><td><code>123456</code></td></tr><tr><td>Admin PIN</td><td>不明 (今回これを利用)</td><td><code>12345678</code></td></tr><tr><td>PUK</td><td>PIN のブロック解除 (今回利用しない)</td><td><code>12345678</code></td></tr><tr><td>Management key</td><td>エンティティの認証 (今回利用しない)</td><td><code>0102030405060708</code> の 3DES</td></tr></tbody></table><p>参考:</p><ul><li><a href="https://docs.yubico.com/yesdk/users-manual/application-piv/pin-puk-mgmt-key.html" target="_blank" rel="noopener noreferrer">The PIV PIN, PUK, and management key - (docs.yubico.com)</a></li><li><a href="https://wiki.archlinux.jp/index.php/YubiKey" target="_blank" rel="noopener noreferrer">YubiKey - ArchWiki - (wiki.archlinux.jp)</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="だめだった方法">だめだった方法<a href="#だめだった方法" class="hash-link" aria-label="だめだった方法 への直接リンク" title="だめだった方法 への直接リンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ykman">ykman<a href="#ykman" class="hash-link" aria-label="ykman への直接リンク" title="ykman への直接リンク">​</a></h3><p>設定時にインストールしていたため、最初このツールでの解除を図った。</p><p>ドキュメント内から<a href="https://docs.yubico.com/software/yubikey/tools/ykman/PIV_Commands.html#ykman-piv-access-unblock-pin-options" target="_blank" rel="noopener noreferrer">Unblock the PIN (using PUK).</a>と書かれているものがあったためこれを実行した。</p><blockquote><p>WARNING: PC/SC not available. Smart card protocols will not function.</p></blockquote><p>のようなエラーが出た場合は<a href="https://www.reddit.com/r/yubikey/comments/p94xwl/yubikey_wont_register_on_arch_linuxs_desktop_auth/" target="_blank" rel="noopener noreferrer">ここ</a>を参考に<code>sudo systemctl start pcscd.service</code>することで無事実行できるようになる。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ykman piv access unblock-pin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Enter PUK:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Enter a new PIN:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; PIN unblocked</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>しかし<code>git commit</code>を実行しても PIN のロックは解除できていなかった。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="yubico-piv-tool">yubico-piv-tool<a href="#yubico-piv-tool" class="hash-link" aria-label="yubico-piv-tool への直接リンク" title="yubico-piv-tool への直接リンク">​</a></h3><p>上記とは<a href="https://tech.yubion.com/documents/piv/admin_guide/yubikey/change-puk/" target="_blank" rel="noopener noreferrer">別のツールがあった</a>ためこれを利用して解除を試みた。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yubico-piv-tool -a unblock-pin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Enter puk:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Enter new pin:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Verifying - Enter new pin:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Successfully unblocked the pin code.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>若干出力は異なるものの、概ね<code>ykman</code>と同様の出力となり、同じくロックの解除はできていなかった。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="再発防止のための暫定的な対応">再発防止のための暫定的な対応<a href="#再発防止のための暫定的な対応" class="hash-link" aria-label="再発防止のための暫定的な対応 への直接リンク" title="再発防止のための暫定的な対応 への直接リンク">​</a></h2><p>大文字/小文字、打ち間違いなどを考慮するとリトライ回数が 3 回では不足が考えられたので、下記の通り設定を変更した。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yubico-piv-tool -a verify -P </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">${YUBIKEY_PIN}</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -a pin-retries --pin-retries</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> --puk-retries</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>参考: <a href="https://tech.yubion.com/documents/piv/admin_guide/yubikey/change-retry-count/" target="_blank" rel="noopener noreferrer">PIN/PUK のリトライ回数の変更 - YubiKey PIV Manual - (tech.yubion.com)</a></p>]]></content:encoded>
            <category>gpg</category>
            <category>git</category>
            <category>yubikey</category>
        </item>
        <item>
            <title><![CDATA[【Docker】EPEL版nginxをDocker Composeへ移行し管理する]]></title>
            <link>https://notes.ogumaru.dev/2023/01/09/migrate-nginx-docker</link>
            <guid>https://notes.ogumaru.dev/2023/01/09/migrate-nginx-docker</guid>
            <pubDate>Mon, 09 Jan 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[概要]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要 への直接リンク" title="概要 への直接リンク">​</a></h2><p>Amazon Linux 2 の EPEL 版 nginx を Docker の nginx に移行する。</p><p>併せて、Docker で稼働する他のアプリケーションコンテナも Docker Compose を利用して同一ネットワークにて管理する。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="環境">環境<a href="#環境" class="hash-link" aria-label="環境 への直接リンク" title="環境 への直接リンク">​</a></h2><table><thead><tr><th>項目</th><th>バージョン / 種類</th></tr></thead><tbody><tr><td>EC2 インスタンスタイプ</td><td>t4g.nano</td></tr><tr><td>OS</td><td>Amazon Linux release 2 (Karoo)</td></tr><tr><td>nginx (EPEL)</td><td>nginx version: nginx/1.12.2</td></tr><tr><td>nginx (docker)</td><td>nginx:1.23.3</td></tr><tr><td>Docker</td><td>Docker version 20.10.13, build a224086</td></tr><tr><td>Docker Compose</td><td>Docker Compose version v2.14.2</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="詳細">詳細<a href="#詳細" class="hash-link" aria-label="詳細 への直接リンク" title="詳細 への直接リンク">​</a></h2><p>Amazon EC2 上に リバースプロキシとして振る舞う nginx の Web サーバがあり、これを通じて<a href="https://github.com/go-shiori/shiori/pkgs/container/shiori" target="_blank" rel="noopener noreferrer">Docker 版の Shiori</a>を利用できるようにしている。</p><p><img loading="lazy" alt="概要図" src="/assets/images/outline-f05dd25907d1df69d1dff55ca71b3711.png" title="概要図" width="1010" height="702" class="img_ev3q"></p><p>上図左の通り、移行前の構成ではパッケージ版の nginx が外部からリクエストを受ける。</p><p>この nginx から<code>proxy_pass</code>により、内部で稼働するアプリケーションコンテナ(<code>shiori</code>)へ転送している。</p><p>移行後の構成としては上図右のように、ホスト側の<code>443</code>番ポートを Docker Compose のネットワーク内で稼働する nginx へ接続し、ここで外部からのリクエストを受ける。</p><p>この nginx から<code>proxy_pass</code>により、同じネットワーク内にあるアプリケーションコンテナへ転送する。</p><p>外部とは Let's Encrypt の証明書を利用した HTTPS 接続を行う。</p><p>Certbot はひとまず現行と同じく EPEL リポジトリのものを利用する。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="各種設定ファイル">各種設定ファイル<a href="#各種設定ファイル" class="hash-link" aria-label="各種設定ファイル への直接リンク" title="各種設定ファイル への直接リンク">​</a></h2><p>ファイルの配置は以下の通りとする</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">├── docker-compose.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── conf.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── shiori.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── shiori</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── archive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── shiori.db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── thumb</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="docker-composeyaml"><code>docker-compose.yaml</code><a href="#docker-composeyaml" class="hash-link" aria-label="docker-composeyaml への直接リンク" title="docker-composeyaml への直接リンク">​</a></h3><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"3"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">nginx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">1.23.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /etc/letsencrypt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/etc/letsencrypt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /var/www</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/var/www</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./nginx/conf.d</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/etc/nginx/conf.d</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token datetime number" style="color:#36acaa">80:80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 443</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shiori</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ghcr.io/go</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">shiori/shiori</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v1.5.3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">35</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">g27c2fc7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shiori</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"${HOME}/shiori:/shiori"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> PUID=1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> PGID=1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> always</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>/etc/letsencrypt</code>は Let's Encrypt の証明書関連のファイルを参照するためにマウントする。</p><p><code>/var/www</code>は<code>certbot</code>による証明書更新の際、<code>.well-known</code>を<code>nginx</code>から外部に公開するためにマウントする。</p><p>この更新のために、<code>80</code>番ポートもバインドする。</p><p><code>/nginx/conf.d</code>には後述する設定ファイルを配置する。</p><p><code>shiori</code>の部分については、もともと下記のようなスクリプトで稼働していたものから移行した。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run --rm -d /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">always </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --name shiori </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -v </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable builtin class-name" style="color:#36acaa">pwd</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">/shiori:/shiori"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -u </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">id</span><span class="token string variable" style="color:#36acaa"> -u</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">:</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">id</span><span class="token string variable" style="color:#36acaa"> -g</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain">:8080 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shiori:v1.5.3-35-g27c2fc7</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>nginx</code>が同一ネットワークになるため、<code>shiori</code>の<code>8080</code>番ポートは外部に公開(<code>publish</code>)はしない。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nginx-の設定ファイル">nginx の設定ファイル<a href="#nginx-の設定ファイル" class="hash-link" aria-label="nginx の設定ファイル への直接リンク" title="nginx の設定ファイル への直接リンク">​</a></h3><p>nginx の設定ファイルは以下の通り<code>https://shiori.example.com</code>でアクセスできる設定とする。</p><div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        listen 80;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        server_name shiori.example.com;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        location ^~ /.well-known {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                alias           /var/www/.well-known;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        location / {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return 301 https://$host$request_uri;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        server_name shiori.example.com;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        listen 443 http2 ssl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- 各種設定 --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ssl_certificate         /etc/letsencrypt/live/shiori.example.com/fullchain.pem;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ssl_certificate_key     /etc/letsencrypt/live/shiori.example.com/privkey.pem;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        location / {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                proxy_pass      http://shiori:8080/;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                proxy_set_header HOST $host;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                proxy_set_header X-Forwarded-Host $host;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                proxy_set_header X-Real-IP $remote_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;!-- 各種設定 --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="certbot">Certbot<a href="#certbot" class="hash-link" aria-label="Certbot への直接リンク" title="Certbot への直接リンク">​</a></h3><p>Certbot による証明書の自動更新を<code>certbot-renew.timer</code>にて行っていたため、Hook の設定も下記の通り変更する。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudoedit /etc/letsencrypt/renewal-hooks/post/reload-nginx.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> #!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49"> systemctl reload nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa"> docker exec nginx nginx -s reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="動作確認">動作確認<a href="#動作確認" class="hash-link" aria-label="動作確認 への直接リンク" title="動作確認 への直接リンク">​</a></h2><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 既存のWebサーバの停止</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl stop nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 既存のアプリケーションコンテナの停止</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> stop shiori</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> compose up -d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 証明書の更新、Hookの確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> certbot --dry-run renew</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>docker</category>
            <category>docker-compose</category>
            <category>nginx</category>
            <category>certbot</category>
            <category>shiori</category>
        </item>
        <item>
            <title><![CDATA[【WASM】wasm-pack packがos error 2で失敗する]]></title>
            <link>https://notes.ogumaru.dev/2022/11/27/wasm-pack-cannot-pack-oserr2</link>
            <guid>https://notes.ogumaru.dev/2022/11/27/wasm-pack-cannot-pack-oserr2</guid>
            <pubDate>Sun, 27 Nov 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[概要]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要 への直接リンク" title="概要 への直接リンク">​</a></h2><p>devcontainer 内にて、WebAssembly の npm パッケージを<code>wasm-pack pack</code>するとエラーが発生する。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="結論">結論<a href="#結論" class="hash-link" aria-label="結論 への直接リンク" title="結論 への直接リンク">​</a></h2><p>Node.js を devcontainer 側にインストールする。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="環境">環境<a href="#環境" class="hash-link" aria-label="環境 への直接リンク" title="環境 への直接リンク">​</a></h2><table><thead><tr><th>項目</th><th>バージョン</th></tr></thead><tbody><tr><td>cargo</td><td>1.64.0 (387270bc7 2022-09-16)</td></tr><tr><td>wasm-pack</td><td>0.10.3</td></tr><tr><td>docker</td><td>version 20.10.14, build a224086</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="詳細">詳細<a href="#詳細" class="hash-link" aria-label="詳細 への直接リンク" title="詳細 への直接リンク">​</a></h2><p><code>mcr.microsoft.com/vscode/devcontainers/rust:0-bullseye</code>を元にした devcontainer 内に、下記にて<code>wasm-pack</code>をインストールしていた。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> wasm-pack</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>このコンテナ内で<code>wasm-pack build</code>はできるものの、<code>wasm-pack pack</code>は下記のエラーが発生した。</p><blockquote><p>Error: Packaging up your code failed<br>
<!-- -->Caused by: No such file or directory (os error 2)</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="対応">対応<a href="#対応" class="hash-link" aria-label="対応 への直接リンク" title="対応 への直接リンク">​</a></h2><p>公式ドキュメントや Web 上を検索しても情報がなく困ったが、<code>npm pack</code>を内部で呼び出しているのかと考え、下記コマンドを利用できるようにしたところ、無事<code>wasm-pack pack</code>にて npm パッケージを作成することができた。</p><ul><li><code>node</code></li><li><code>npm</code></li><li><code>npx</code></li></ul><p><code>npm</code>とサブコマンドが似ていることから当然といえばそうかもしれないが、気づかずに結構時間を使ってしまった。</p><p>なお、<code>apt</code>で入るものはバージョンが古いため、(差分が大きいが)下記コミットのようにアーカイブを展開する形で対応した。</p><p><a href="https://github.com/ogumaru/wanco/commit/ff650765c668002ea1b8e8f056ef8a4907b6a6f8" target="_blank" rel="noopener noreferrer">update: devcontainer configuration (ff650765c668002ea1b8e8f056ef8a4907b6a6f8)</a></p><p>Node.js に関する該当箇所は下記</p><div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM busybox:1.34.1 as nodejs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV NODEJS_TARBALL_URL="https://nodejs.org/dist/v18.12.1/node-v18.12.1-linux-x64.tar.xz"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USER root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /root/.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN mkdir -p bin/ node/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;&amp; wget -O node.tar.xz "${NODEJS_TARBALL_URL}" --no-check-certificate \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;&amp; xz -d -c node.tar.xz | tar xvf - -C node --strip-components 1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;&amp; ln -s "/root/.local/node/bin/node" bin/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;&amp; ln -s "/root/.local/node/bin/npm" bin/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;&amp; ln -s "/root/.local/node/bin/npx" bin/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;&amp; rm node.tar.xz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>javascript</category>
            <category>wasm</category>
            <category>rust</category>
        </item>
        <item>
            <title><![CDATA[【React】CalciteSwitchで見た目が変わらない]]></title>
            <link>https://notes.ogumaru.dev/2022/11/27/calcite-switch-state</link>
            <guid>https://notes.ogumaru.dev/2022/11/27/calcite-switch-state</guid>
            <pubDate>Sun, 27 Nov 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[概要]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要 への直接リンク" title="概要 への直接リンク">​</a></h2><p>有効/無効の 2 つの状態を持つ要素を利用して、<code>createContext</code>で作成した状態を保持・切り替えさせたい。</p><p>Calcite Design System の<code>CalciteSwitch</code>を利用し、状態をクリックで変更しようとしたが、実際はクリックをしても見た目が有効なまま変わらなかった。</p><p>意図した動作としては、選択状態に応じて下の表のようになる。</p><table><thead><tr><th>スイッチの状態</th><th>表示</th></tr></thead><tbody><tr><td>有効</td><td><img loading="lazy" alt="青、右" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEwAAAAmCAYAAABu+H0XAAAGR0lEQVRoQ91af0yUdRj/HL+O4+edKAfhAq7syi3AlmGSDoaWtVm6op+mueqfJqWbJs3+YCMTZabNP6xhM8nalEybpqZjFAYKf4RQEuAEbwMBA7wTDg4Oub7Pe7zcvfcecMcdL29+N3bc7r3n+d7n+3me7/NLYbFYbLjP1ummO6i42Ye6TjP3y+q7BmC03OP+T40LQ7QykL2GY3lSJPuL4t57uhTTAczQ049L12/j96YOGHrMqLje5am+mXsuMASImAOERgABngOgDg3Ear0GuUvikaJVTbk/rwA7eqUFB8oaUNd2Z0rBkj3AAxUW7bPKFxlwxWt0kzLOI8BO17Vh6/EaGHrtFOcWnWRIGBAcan8fMvXp+PyL3Aogj6Lwm2hiXNFziXg7da5bmZMCZhq0IudgucPkAoMY7Zmg0EhG+wC/bXJagibBKYht7bF54Xj18blIUquQkRyJZHUoWo0WVLb24aZxEMfqu9HYbcbIqHvtuelxDLgHRR9OCFg9M7uVey/AZBlmB8hOMHIeEK6Z1m+T6kvKQAUKV+mweekDHqvcX3ULeedbMHRPfPcRy4pf0glkuQWsormLY5bJYgWClEAMQ3q2GTW+bTG1iOtvpsaiJEfPna23y8ZEri9twg91t+FKOFfQRIARs1bs/RV3CSxVFBCllRFYYiiCGEBl76Vy4YGvq+yGEasO/4URF7IRy3ifJgCMfJZ+x08wDjIzJLDU8b7uwY/fJ+rQ+TsoRCbYnpeOmLBgv+npGbAiobBaYKLRygA0b17E3Z4CwJ794oLdwcvODBkeLpYYHKBAzQeLkBYf7jeweEG1t8xIP/gnrE72SSHH8dcWOACj0CHnq3K7g499WGZmSKwS2smeVcnYtmy+38HiBRZdasPH51sF8ps+THMARqbIxVlRsfK7DV3YpY0IRucnS2YMLF5w3K4r6OpnvnxsrUuZawfsu8s38H5JFUBxVuxDM74R7xUIESt/NwWZOt8j+6n28VuLCVnf1IvDivSdZ+zpTnQc4IcUY6qN+PJ5HGNXhwTs4vcYkV8Js5MzUzS1d9v0n560f65dIDPfRZsSsmt9mhZHch7xBXOvvruhtBklVx3FBUVx+TUbZ46UG2oSvBImycMu/uvkWwuxZmGMJKpJyamGHqz9vmFcn2Ld12U2qkLI0tmLCQap/BePkKsfUyz7/Gcb1ba49GfWKg6TEUZIMdvOZZKxixQZLSPQFFx2MAwbi+0BjmwBE+IjNWCkXbHjkhvA4vWSnpzHyigzdsqopQZsYobJFjA6Yge8s+7DZG+Scrsl/29Of8MiLb59Rbo47J0fm3Gk1ikOk31Y4eLsktRKtG57ymMX6OuDmoKq8RYddwHIPnDlYjGh45fKj7nNJeWfGhFgQscvFcuSi2pYw2TIQdKBu/ZqxZOfncbf7UYZJ9/ieti+F1izI2PmUrn9le3YcpZlQE5rsWoMsPHyTgAr72jlWN4Rs4z6h+Wslj8TFderHWZkHaoT+C5Y+lG8OtFRQEzKO4FO04B8c0oKxmysZuwUxBJodAGoQ9lB+2lRoEqmyM9icGJH70E71AnDrrXuStSsaUVFRNm01SZHwp9Mc8ssUm/qROn6J7A6db6wCfJ04TnUGrpZE4QNdsQkyhQ0cV+SQMvPTsRHS6fv076sakd+mUHILAKLOfrsBAV+yc3mTk7UZkvcXgqLlY0Gya7N5sS0CcYE6PY8/LLeq/I1hQ4bTzQJb0NeFQNLM3IHjQVrEK2yt/LcNnKf2X0OwyNjoMm2kTvxcAUBl6lTc4VG8m+prBVHr+Sf6phDp1cqDJ5q6BYzigfL3IuQgV78sf15pMx3jEi4HRWg7nfG7rOw0qSGrM1THNT67PuZg0ffvwgZ7heB5ZZhvEICbfmec3bzVLCLIJJN7chyGIVuT8oEfIYKFDrA1AG1KgQXNq8QMIuXPuW4Uyab4Pmnvdf+PMVpUWyKR0lTfrM87iTCZww4Sgu8mUghsAkoZoKwWrBYp8WZTVnjPstVjUcDdUerDdhyrBp9g05pAoGmpIE6Nt1Di4brZLPG5jBsPO2cQBxlbob+rCzmJKCGWfOavY9UKXHgjXS8vphFB5MsjwDjv190sRH7Ll5Dbx9Tdp+suDlR2JSpx9aVj3r0i/4D+sCfl3cIGOMAAAAASUVORK5CYII=" title="青、右" width="76" height="38" class="img_ev3q"></td></tr><tr><td>無効</td><td><img loading="lazy" alt="白、左" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEwAAAAmCAYAAABu+H0XAAAFNklEQVRoQ+1aR0ssTRS9bc6Yc3bjTl2oG1e6UFcGXLnQH+DfURR0o4IomHCjIAqCYEJEVExgFnPOif489aj+qmd6nO55Ttvy5oLMmzfVFU7fVOde6fn5WSaDsru7S0dHR3RxccGe5J9RUVHsOz7T09MpPj7e4MzWHy7pBez+/p7m5+cJYL2+vuo6mbe3N8XExFBGRgb5+/vresadg7AHLy8v8vHxoaCgIAoMDGT/NiJOAeNAbW5uGpnXbiy0zSrAiZsDaGFhYRQaGqrrfF8CBpCmpqZ0a5SzFX19famwsJCysrKcDXXL75/WxOZ9e3ujp6cn9scFmhYbG8s07ytxCNj09DQtLy9rPhsSEkIJCQmUmZnJTI37Lviyl5cX2traYj4O2qklubm5lJOT4xZQjEwqyzI9Pj7S1dUVfXx8sEeDg4OZ75UkSXMqTcAmJiZIywQBVHFxMaWkpOja1/7+Po2Pj2sCBy0rKirSNY8Zg+7u7hhwABHalpiYSH5+fnZL2wEGE1xZWVENhCnl5+dTXl6eS3tfWFigubk5ZgqiQMugbVYRgHV8fMxcEIJDcnKyHWgqwKBV0C5RAFZVVRWLdn8jZ2dnNDAwYAcatOynfJrWeQAaXMvDw4MmaApg8Dd9fX2qA0El6+rqvi0lgH/r6OhQBRG8kIqKCuY7rCTn5+cKaIju3KcpgNn6LRykurqaoqOjv/Uc2Eh/f7/qxVjNn+HAonniZSLIQRhg0K7u7m4VMDAVd0WyxcVFmpycVK1XU1NjOS0DaAhc+EQQQMrBALPVLiRxMEV3Snt7uyp6WlHLcP7r62u6ublhkRPXPQYYNi9GsMrKSkpKSnInXnR4eEiDg4PKGnABtbW1bl3T1ckPDg5YnhYXF0fS+vq6PDo6qsxlhnbxxVpbW1UBoLS01JIXdkRM+F5co6SxsTF5dXVVASw7O5tKSkpcfRmGnvtcm9bW1lRr4+pkNYEP29vb++P0e3p6ZORIXMrLy9mVxwzBFWp4eFhZCipfVlZmxtKG1zg9PWV3T6mrq0u+vLxUJjDDf/HFbP2YlQHD1Qk4SS0tLfL7+7sCWENDg2H0XX0AiWxbW9uvcPxgOk5OTkhqbGxUMa5mAgakmpqaVHjX19e7ir9bn1MAa25uljm1gRXNBOw3aRiwAdssdXZ2ykjMuHh8mGNF1QTMEyW1AVNMcmhoSOY5BoZ68jAngM3MzMgg97h4Mn1twJS04jNplXt7exVOG8PN8GO/6S4JTJTE9ZPakUdGRhg1a6aWgUjEW+NiVbYC+1NdjcBWaFHTHj7sf9Pkl++AgIA/9A7eNDgxUctAT4PLdwfjCm5frJ5bWbsAm4re4a0CYA1QMRKT2H+Z0+f6pUkg4kcUNFEOE6ke/P93aRr4JFvNwvxWqxqJMdIhRc0HQfWWlpYYGyoKQCsoKHCZ4weHPzs7a9dyYLW6pC1YvEZpVwThA4EoOCpomejPxOgJclEvfQ3gQRKK0fA3REXskZfZwOWnpaXZl9n4QeCMUSnZ2Niw0zQROID2VW8FgHfUFmV1zeKFXNQi0RYhtgxo9lZw0KBlSDlEvkxlqwa//HT3jrPtirVILbDwvMPuHQ4aLp3b29uaJupsA+LvSB3Qm2G1CjffIxgb/BluRrF1fPBDAA3c1c7ODrNt26YSR8BBo1JTUy0LlFa7E4q1qHIbaneyBQApB+5S3DSRm6A1CBkwJsZ3SGRkJPuMiIhgjtJqPa546RBYz7c31Glpze3tLQNHb4+rEZP9qbFoCAwPD9fdsvkfq+mFmzA59CUAAAAASUVORK5CYII=" title="白、左" width="76" height="38" class="img_ev3q"></td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="環境">環境<a href="#環境" class="hash-link" aria-label="環境 への直接リンク" title="環境 への直接リンク">​</a></h2><table><thead><tr><th>項目</th><th>バージョン</th></tr></thead><tbody><tr><td>@esri/calcite-components-react</td><td>0.32.0</td></tr><tr><td>react</td><td>18.2.0</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="原因対策">原因・対策<a href="#原因対策" class="hash-link" aria-label="原因・対策 への直接リンク" title="原因・対策 への直接リンク">​</a></h2><p><code>onClick</code>でイベントの処理をしつつ<code>checked={context.isSetAttr}</code>のように<code>checked</code>プロパティで状態管理をすると適切に表示されなくなる。</p><p><code>checked=true</code>や<code>checked</code>であれば当然青になるが、<code>checked=false</code>であっても表示が上の表の「有効」のものになる。</p><p>ドキュメントには<code>checked</code>は<code>true</code>, <code>false</code>を持つとあるが、実際には<code>false</code>だと意図した通りの表示にならない。</p><p>下記コードでは状態に関わらず「有効」のものが表示される。</p><p>(<code>context</code>は上位コンポーネントより渡しており、<code>isSetAttr</code>は<code>boolean</code>)</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">CalciteSwitch</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">checked</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f">context</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">isSetAttr</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">onClick</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript" style="color:#00009f">e</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript arrow operator" style="color:#393A34">=&gt;</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript" style="color:#00009f">    </span><span class="token tag script language-javascript keyword" style="color:#00009f">const</span><span class="token tag script language-javascript" style="color:#00009f"> input </span><span class="token tag script language-javascript operator" style="color:#393A34">=</span><span class="token tag script language-javascript" style="color:#00009f"> e</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">target</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript keyword" style="color:#00009f">as</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript maybe-class-name" style="color:#00009f">HTMLInputElement</span><span class="token tag script language-javascript punctuation" style="color:#393A34">;</span><span class="token tag script language-javascript" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript" style="color:#00009f">    context</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript method function property-access" style="color:#d73a49">setIsSetAttr</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript" style="color:#00009f">input</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">checked</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript punctuation" style="color:#393A34">;</span><span class="token tag script language-javascript" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript" style="color:#00009f">  </span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f"></span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>正しくは下記のように<code>onCalciteSwitchChange</code>でイベントの処理をしつつ、<code>checked</code>に状態を持たせない。</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">CalciteSwitch</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">onCalciteSwitchChange</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript" style="color:#00009f">e</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript arrow operator" style="color:#393A34">=&gt;</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript" style="color:#00009f">    </span><span class="token tag script language-javascript keyword" style="color:#00009f">const</span><span class="token tag script language-javascript" style="color:#00009f"> input </span><span class="token tag script language-javascript operator" style="color:#393A34">=</span><span class="token tag script language-javascript" style="color:#00009f"> e</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">target</span><span class="token tag script language-javascript punctuation" style="color:#393A34">;</span><span class="token tag script language-javascript" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript" style="color:#00009f">    context</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript method function property-access" style="color:#d73a49">setIsSetAttr</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript" style="color:#00009f">input</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">checked</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript punctuation" style="color:#393A34">;</span><span class="token tag script language-javascript" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript" style="color:#00009f">  </span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f"></span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>Fires when the <code>checked</code> value has changed. <strong>Note:</strong> The event payload is deprecated, use the component's <code>checked</code> property instead.</p></blockquote><p><a href="https://developers.arcgis.com/calcite-design-system/components/switch/#component-api-events-calciteSwitchChange" target="_blank" rel="noopener noreferrer">Switch | Calcite Design System | ArcGIS Developers - (developers.arcgis.com)</a></p><p>これで意図した表示にはなるが、コンポーネント自体に状態を保持しておらず、複数箇所からの操作がある場合に若干不安がある。</p>]]></content:encoded>
            <category>typescript</category>
            <category>javascript</category>
            <category>react</category>
        </item>
        <item>
            <title><![CDATA[【JavaScript】ArcGISで動的にMapViewを配置する]]></title>
            <link>https://notes.ogumaru.dev/2022/10/20/arcgis-set-dynamically</link>
            <guid>https://notes.ogumaru.dev/2022/10/20/arcgis-set-dynamically</guid>
            <pubDate>Thu, 20 Oct 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[概要]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要 への直接リンク" title="概要 への直接リンク">​</a></h2><p><a href="https://developers.arcgis.com/javascript/latest/" target="_blank" rel="noopener noreferrer">ArcGIS API for JavaScript</a> (<code>@arcgis/core</code>)で <code>MapView</code> を利用する際、インスタンス化時に <code>container</code> プロパティにセレクタの文字列か<code>HTMLElement</code>を指定することで、そこに地図を表示することができる。</p><p>React を利用する都合上、静的な HTML ではなく、表示対象となる要素(React コンポーネント)が描画されたあと、そこに表示されるようにしたい。</p><p>実装は ES Modules および TypeScript を利用して行った。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="結論">結論<a href="#結論" class="hash-link" aria-label="結論 への直接リンク" title="結論 への直接リンク">​</a></h2><p><code>useEffect</code>内で<code>__esri.Accessor.set()</code>から<code>container</code>を指定する。</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> useEffect </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"react"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">MapView</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"@arcgis/core/views/MapView"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ここでは container は指定しない。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// レイヤの操作をする都合上、</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// export する必要があるためsetup内でインスタンス化できない。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> mapView </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MapView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** 略 **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">setup</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 動的に container を指定</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mapView</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"container"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"viewDiv"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">App</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">setup</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">viewDiv</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="環境">環境<a href="#環境" class="hash-link" aria-label="環境 への直接リンク" title="環境 への直接リンク">​</a></h2><table><thead><tr><th>項目</th><th>内容</th></tr></thead><tbody><tr><td>React</td><td>18.2.0</td></tr><tr><td>ArcGIS API for JavaScript</td><td>4.24.7</td></tr><tr><td>TypeScript</td><td>4.8.4</td></tr><tr><td>webpack</td><td>5.74.0</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="動的な配置">動的な配置<a href="#動的な配置" class="hash-link" aria-label="動的な配置 への直接リンク" title="動的な配置 への直接リンク">​</a></h2><p><code>MapView</code>がインスタンス化されたときに<code>container</code>に指定した際、この時点で該当の HTML 要素がない場合は地図が表示されない。</p><p>React を利用している場合、コンポーネントがマウントされたタイミングで描画されるように、<code>useEffect</code>内で<code>MapView</code>をインスタンス化すれば問題なく表示ができる。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="containerプロパティ"><code>container</code>プロパティ<a href="#containerプロパティ" class="hash-link" aria-label="containerプロパティ への直接リンク" title="containerプロパティ への直接リンク">​</a></h2><p>サンプルコードなどでは下記のようにコンストラクタで<code>container</code>に HTML 要素の<code>id</code>文字列を指定することが多い。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> mapView </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MapView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// (略)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  container</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"viewDiv"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>このとき、<code>container</code>プロパティの型は <code>string | HTMLDivElement</code>となっているため、TypeScript の型エラーは出ない。</p><p>(ヒントには<code>__esri.DOMContainerProperties.container?: string | HTMLDivElement</code>とでるが、該当の型はドキュメントには見つからなかった)</p><p><a href="https://developers.arcgis.com/javascript/latest/api-reference/esri-views-MapView.html#container" target="_blank" rel="noopener noreferrer">MapView | API Reference | ArcGIS API for JavaScript 4.24 | ArcGIS Developers - (developers.arcgis.com)</a></p><p>一方、<code>MapView</code>がインスタンス化された場合、<code>container</code>プロパティは<code>DOMContainer.container</code>を指してしまい、指定できるのは<code>HTMLDivElement</code>のみとなる。</p><p><a href="https://developers.arcgis.com/javascript/latest/api-reference/esri-views-DOMContainer.html#container" target="_blank" rel="noopener noreferrer">DOMContainer | API Reference | ArcGIS API for JavaScript 4.24 | ArcGIS Developers - (developers.arcgis.com)</a></p><p>そのため下記コードでは型エラーが発生してしまう。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> mapView </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MapView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mapView</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">container </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"viewDiv"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>Type 'string' is not assignable to type 'HTMLDivElement'.ts(2322)</p></blockquote><p><code>MapView</code>ではなく、これが継承している<code>__esri.Accessor</code>が<code>set</code>メソッドを持っており、これを利用することで動的に<code>container</code>を指定することができた。</p><p><a href="https://developers.arcgis.com/javascript/latest/api-reference/esri-core-Accessor.html#set" target="_blank" rel="noopener noreferrer">Accessor | API Reference | ArcGIS API for JavaScript 4.24 | ArcGIS Developers - (developers.arcgis.com)</a></p>]]></content:encoded>
            <category>typescript</category>
            <category>javascript</category>
            <category>arcgis</category>
            <category>react</category>
        </item>
        <item>
            <title><![CDATA[【JavaScript】Wayland + Chromium環境でファイルのファイルドロップがたまに失敗する]]></title>
            <link>https://notes.ogumaru.dev/2022/10/16/dnd-behavior-on-wayland</link>
            <guid>https://notes.ogumaru.dev/2022/10/16/dnd-behavior-on-wayland</guid>
            <pubDate>Sun, 16 Oct 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[概要]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要 への直接リンク" title="概要 への直接リンク">​</a></h2><p>ウェブブラウザの File API を利用して、ファイルのドラッグ &amp; ドロップを利用した機能を実装している際、ファイルの検証を行っているにもかかわらず、エラーが発生した。</p><p>必ず失敗するわけではなく、たまに成功するため、動作の確認を行った。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="原因">原因<a href="#原因" class="hash-link" aria-label="原因 への直接リンク" title="原因 への直接リンク">​</a></h2><p>ファイルドロップ時にその中身が変わるのは、Wayland 環境における現状の挙動らしかった。</p><p>参照:</p><ul><li><a href="https://askubuntu.com/questions/1411629/cannot-drag-and-drop-from-nautilus-to-chrome-or-slack" target="_blank" rel="noopener noreferrer">Cannot drag and drop from nautilus to Chrome or Slack - Ask Ubuntu (askubuntu.com)</a></li><li><a href="https://bugs.launchpad.net/ubuntu/+source/nautilus/+bug/1970921" target="_blank" rel="noopener noreferrer">Bug #1970921 “Drag and drop does not work” : Bugs : nautilus package : Ubuntu (bugs.launchpad.net)</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="挙動の確認">挙動の確認<a href="#挙動の確認" class="hash-link" aria-label="挙動の確認 への直接リンク" title="挙動の確認 への直接リンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="環境">環境<a href="#環境" class="hash-link" aria-label="環境 への直接リンク" title="環境 への直接リンク">​</a></h3><table><thead><tr><th>環境</th><th>バージョン</th></tr></thead><tbody><tr><td>OS</td><td>Ubuntu 22.04.1 LTS</td></tr><tr><td>Chromiun</td><td>Chromium 106.0.5249.119 snap</td></tr><tr><td>Firefox</td><td>Mozilla Firefox 105.0.3</td></tr><tr><td>Files</td><td>GNOME nautilus 42.2</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="挙動の詳細と確認">挙動の詳細と確認<a href="#挙動の詳細と確認" class="hash-link" aria-label="挙動の詳細と確認 への直接リンク" title="挙動の詳細と確認 への直接リンク">​</a></h3><p>デバッガを利用して確認を行った。</p><p>下記のようなコードにおいて、<code>csv.getAsFile()</code>が<code>null</code>になるために例外が発生していた。</p><p>体感として失敗する割合のほうが多いように感じる。</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>再現コード</summary><div><div class="collapsibleContent_i85q"><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// CSV形式かどうかの確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">isCSVItem</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> isCSV </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"text/plain"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"text/csv"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"application/vnd.ms-excel"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"application/octet-stream"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> isCSV</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"dragover"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">stopPropagation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">preventDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dataTransfer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dataTransfer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dropEffect</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"copy"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"drop"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">stopPropagation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">preventDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dataTransfer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// item の確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 同じ操作でも異なる結果になる</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> item </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dataTransfer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">items</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token known-class-name class-name">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword module" style="color:#00009f">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dataTransfer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">items</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">isCSVItem</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ここで返り値が null になる</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">csv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> csv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getAsFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Failed to load csv file."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> reader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">FileReader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// file が たまに null になるため例外が発生する</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      reader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">readAsDataURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      reader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"load"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ファイルに対する処理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>成功する場合と失敗する場合を比較すると、上記コードの<code>event.dataTransfer.items</code>の要素(<code>DataTransferItem</code>)の中身に違いがあり、下記 2 通りになっていることがわかった。</p><table><thead><tr><th>処理</th><th>kind</th><th>type</th></tr></thead><tbody><tr><td>成功</td><td>file</td><td>text/csv</td></tr><tr><td>失敗</td><td>string</td><td>text/plain</td></tr></tbody></table><p>Firefox ではこの問題は発生せず、<code>kind: file</code>なものが取得できるため問題なく動作した。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="対策">対策<a href="#対策" class="hash-link" aria-label="対策 への直接リンク" title="対策 への直接リンク">​</a></h2><ol><li>ドロップされたデータの<code>kind</code>が<code>file</code>かどうか判定する</li><li><code>input</code>要素からファイルを選択して取得する<br><code>input[type="file"]</code>ではこの問題は発生しない</li><li>ログイン時に <!-- -->[Ubuntu on Xorg]<!-- --> を利用する</li></ol><p>今回は 1, 2 の対策を行って実装を行った。</p>]]></content:encoded>
            <category>javascript</category>
            <category>linux</category>
        </item>
        <item>
            <title><![CDATA[【Linux】Ubuntu Pro betaを利用してみる]]></title>
            <link>https://notes.ogumaru.dev/2022/10/06/get-started-ubuntu-pro</link>
            <guid>https://notes.ogumaru.dev/2022/10/06/get-started-ubuntu-pro</guid>
            <pubDate>Thu, 06 Oct 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[概要]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要 への直接リンク" title="概要 への直接リンク">​</a></h2><p>また beta がついているが、Ubuntu Pro が<a href="https://ubuntu.com/blog/ubuntu-pro-beta-release" target="_blank" rel="noopener noreferrer">個人でも 5 台まで無償利用できるようになった</a>ため、早速利用してみる。</p><p>全体の流れとしては以下のようになる。</p><ol><li><a href="https://login.ubuntu.com/" target="_blank" rel="noopener noreferrer">Ubuntu One</a>のアカウントの作成</li><li><a href="https://ubuntu.com/pro" target="_blank" rel="noopener noreferrer">Ubuntu Pro</a>へログイン</li><li>トークンの取得</li><li><code>pro</code>コマンドを利用できるようにする</li><li>端末をアタッチ</li></ol><p><a href="https://discourse.ubuntu.com/t/ubuntu-pro-beta-tutorial/31018" target="_blank" rel="noopener noreferrer">Ubuntu Pro beta tutorial</a>を参考に進めれば特に詰まるところもない。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="環境">環境<a href="#環境" class="hash-link" aria-label="環境 への直接リンク" title="環境 への直接リンク">​</a></h2><table><thead><tr><th>項目</th><th>内容</th></tr></thead><tbody><tr><td>OS</td><td>Ubuntu 22.04.1 LTS</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="利用手順">利用手順<a href="#利用手順" class="hash-link" aria-label="利用手順 への直接リンク" title="利用手順 への直接リンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ubuntu-one-アカウントの作成--ubuntu-pro-へログイン">Ubuntu One アカウントの作成 / Ubuntu Pro へログイン<a href="#ubuntu-one-アカウントの作成--ubuntu-pro-へログイン" class="hash-link" aria-label="Ubuntu One アカウントの作成 / Ubuntu Pro へログイン への直接リンク" title="Ubuntu One アカウントの作成 / Ubuntu Pro へログイン への直接リンク">​</a></h3><p>Ubuntu One のアカウントを作成したあと、Ubuntu Pro のページから再度ログインを行うと下図の画面になる。</p><p><img loading="lazy" alt="Personal Data Request" src="/assets/images/Personal_Data_Request-1a4c031b0b874332c27f62286e682902.png" title="Personal Data Request" width="1187" height="661" class="img_ev3q"></p><p>なお、「Service authorization for Ubuntu.com」はチェックを入れないと進めなかった。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="トークンの取得">トークンの取得<a href="#トークンの取得" class="hash-link" aria-label="トークンの取得 への直接リンク" title="トークンの取得 への直接リンク">​</a></h3><p>Ubuntu Pro にログイン後、下記の画面から「UA subscriptions」を押下するとトークンが確認できる。</p><p><img loading="lazy" alt="UA Subscriptions" src="/assets/images/UA_subscriptions-27b86d151171f80f126acdcc09c06d75.png" title="UA Subscriptions" width="1402" height="822" class="img_ev3q"></p><p><code>Token</code>とある箇所にトークン、その下にはアタッチの際のコマンドが書いてある。</p><p><img loading="lazy" alt="Your subscriptions" src="/assets/images/Your_subscriptions-8b38a57ccc79d2f37d40dfd5ece127c1.png" title="Your subscriptions" width="1394" height="878" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="proコマンドを利用できるようにする"><code>pro</code>コマンドを利用できるようにする<a href="#proコマンドを利用できるようにする" class="hash-link" aria-label="proコマンドを利用できるようにする への直接リンク" title="proコマンドを利用できるようにする への直接リンク">​</a></h3><p>詳細は後述するが、<code>pro</code>コマンドのために追加でインストールが必要にはならなかった。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> upgrade</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="端末のアタッチ">端末のアタッチ<a href="#端末のアタッチ" class="hash-link" aria-label="端末のアタッチ への直接リンク" title="端末のアタッチ への直接リンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> pro attach </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">${表示されているTOKEN}</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Enabling default service esm-infra</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Updating package lists</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Ubuntu Pro: ESM Infra enabled</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Enabling default service livepatch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Installing canonical-livepatch snap</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Canonical livepatch enabled.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Unable to determine current instance-id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; This machine is now attached to 'Ubuntu Pro - free personal subscription'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; SERVICE          ENTITLED  STATUS    DESCRIPTION</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; esm-infra        yes       enabled   Expanded Security # &gt; Maintenance for Infrastructure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; livepatch        yes       enabled   Canonical Livepatch service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; NOTICES</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Operation in progress: pro attach</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Enable services with: pro enable &lt;service&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;      Account: ogumaru@example.com</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Subscription: Ubuntu Pro - free personal subscription</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>実行もほとんど時間はかからず、特に再起動を求められることはなかった。</p><p>上記コマンドでアタッチ後にはトップバーに下図の常駐アイコンが表示されるようになる。</p><p><img loading="lazy" alt="Livepatchのアイコン" src="/assets/images/Livepatch-afe6d8acd5af2c9737a3e48f534388e7.png" title="Livepatchのアイコン" width="286" height="164" class="img_ev3q"></p><p>「Livepatch Settings」を押下するとライブパッチの設定のほか、トップバーの常駐アイコン表示切り替えや端末のデタッチもできる。</p><p><img loading="lazy" alt="Detach this machine" src="/assets/images/Detach_this_machine-1385d7dc8f1f9f0ce8b5c5c80c6269ec.png" title="Detach this machine" width="998" height="523" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="トークンについて">トークンについて<a href="#トークンについて" class="hash-link" aria-label="トークンについて への直接リンク" title="トークンについて への直接リンク">​</a></h2><p><code>Token</code>は端末認証後も変わらず(=5 台とも同じトークンを利用するはず)、またトークンの更新画面も見つからなかった。</p><p>トークンが漏れてしまった場合の対策は気になる。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="proコマンドの実体について"><code>pro</code>コマンドの実体について<a href="#proコマンドの実体について" class="hash-link" aria-label="proコマンドの実体について への直接リンク" title="proコマンドの実体について への直接リンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="結論">結論<a href="#結論" class="hash-link" aria-label="結論 への直接リンク" title="結論 への直接リンク">​</a></h3><p><code>ubuntu-advantage</code>が実体となっている。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="proコマンドの有無"><code>pro</code>コマンドの有無<a href="#proコマンドの有無" class="hash-link" aria-label="proコマンドの有無 への直接リンク" title="proコマンドの有無 への直接リンク">​</a></h3><p>これまでの環境では<code>pro</code>コマンドは利用できなかった。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># pro コマンドは利用できない</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">command</span><span class="token plain"> -v pro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 実行してもパッケージの候補にはでてこない</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Command 'pro' not found, did you mean:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   command 'gpro' from snap gpro (1.0.24)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   command 'ro' from deb golang-redoctober (0.0~git20161017.0.78e9720-5)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   command 'proj' from deb proj-bin (8.2.1-1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   command 'prt' from deb prt (0.22-1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   command 'pio' from deb platformio (4.3.4-2)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   command 'pr' from deb coreutils (8.32-4.1ubuntu1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   command 'pry' from deb pry (0.13.1-2)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; See 'snap info &lt;snapname&gt;' for additional versions.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>apt upgrade</code>でパッケージ更新をしたあと利用できるようになる。</p><p>パッケージとしては<code>ubuntu-advantage-tools</code>の一部なようで、これがアップデートされることで<code>pro</code>が利用できるようになるようだ。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> upgrade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; The following packages will be upgraded:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   ubuntu-advantage-tools</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; 1 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Need to get 163 kB of archives.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; After this operation, 113 kB of additional disk space will be # used.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Do you want to continue? [Y/n] y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Get:1 http://jp.archive.ubuntu.com/ubuntu jammy-updates/main # amd64 ubuntu-advantage-tools amd64 27.11.2~22.04.1 [163 kB]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Fetched 163 kB in 0s (723 kB/s)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Preconfiguring packages ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; (Reading database ... 183922 files and directories currently installed.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Preparing to unpack .../ubuntu-advantage-tools_27.11.2~22.04.1_amd64.deb ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Unpacking ubuntu-advantage-tools (27.11.2~22.04.1) over (27.10.1~22.04.1) ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Setting up ubuntu-advantage-tools (27.11.2~22.04.1) ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Installing new version of config file /etc/ubuntu-advantage/help_data.yaml ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Installing new version of config file /etc/ubuntu-advantage/uaclient.conf ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Processing triggers for man-db (2.10.2-1) ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="実体の確認と関連コマンド">実体の確認と関連コマンド<a href="#実体の確認と関連コマンド" class="hash-link" aria-label="実体の確認と関連コマンド への直接リンク" title="実体の確認と関連コマンド への直接リンク">​</a></h3><p><code>pro</code>コマンドの実体を確認すると<code>ubuntu-advantage</code>へのシンボリックリンクになっていた。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">command</span><span class="token plain"> -v pro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; /usr/bin/pro</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable builtin class-name" style="color:#36acaa">command</span><span class="token string variable" style="color:#36acaa"> -v pro</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; /usr/bin/pro: symbolic link to ubuntu-advantage</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>また、<a href="https://ubuntu.com/security/certifications/docs/fips-enablement" target="_blank" rel="noopener noreferrer">ここ</a>に記載されているような<code>ua</code>コマンドも、同様に<code>ubuntu-advantage</code>へのシンボリックリンクとなっていた。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable builtin class-name" style="color:#36acaa">command</span><span class="token string variable" style="color:#36acaa"> -v ua </span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/bin/ua: symbolic </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"> to ubuntu-advantage</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://discourse.ubuntu.com/t/ubuntu-pro-client/31027" target="_blank" rel="noopener noreferrer">Ubuntu Pro Client</a>にも下記の記載がある。</p><blockquote><p>Note: The Ubuntu Advantage client or UA client has been renamed to the Ubuntu Pro client in line with the rebranding of Ubuntu Advantage to Ubuntu Pro 4. Specific commands have also been updated to refer to Ubuntu Pro rather than Ubuntu Advantage.</p></blockquote><p><code>ubuntu-advantage</code>自体を呼び出しても、ヘルプ内は<code>pro</code>となっていた。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu-advantage --help</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; usage: pro &lt;command&gt; [flags]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://github.com/canonical/ubuntu-advantage-client/commit/a92c75598787e33b1c15dee8d05289c49357670f" target="_blank" rel="noopener noreferrer">ドキュメントの修正コミット(docs: ua -&gt; pro)</a>でも見られるように、ドキュメントも<code>pro</code>へ更新されている。</p>]]></content:encoded>
            <category>ubuntu</category>
            <category>linux</category>
        </item>
        <item>
            <title><![CDATA[【Linux】Ubuntu 22.04でWi-FiドングルのドライバをDockerでビルドする]]></title>
            <link>https://notes.ogumaru.dev/2022/10/01/build-wifi-dongle-driver</link>
            <guid>https://notes.ogumaru.dev/2022/10/01/build-wifi-dongle-driver</guid>
            <pubDate>Sat, 01 Oct 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[概要]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要 への直接リンク" title="概要 への直接リンク">​</a></h2><p>これまで Wi-Fi 接続用の USB ドングルを利用する際にドライバのビルドが必要になることがあったため、作業の記録も兼ねてまとめておく。</p><p>依存パッケージが多いため、Docker を利用してビルドを行うこととする。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="環境利用機器">環境・利用機器<a href="#環境利用機器" class="hash-link" aria-label="環境・利用機器 への直接リンク" title="環境・利用機器 への直接リンク">​</a></h2><table><thead><tr><th>環境</th><th>バージョン</th></tr></thead><tbody><tr><td>OS</td><td>Ubuntu 22.04.1 LTS</td></tr><tr><td>Docker</td><td>20.10.14, build a224086</td></tr></tbody></table><table><thead><tr><th>製品</th><th>コントローラ</th></tr></thead><tbody><tr><td><a href="https://www.amazon.co.jp/gp/product/B01N44FMI9/" target="_blank" rel="noopener noreferrer">アイ・オー・データ社 WNPU583B</a></td><td><a href="https://www.realtek.com/ja/products/communications-network-ics/item/rtl8821ce" target="_blank" rel="noopener noreferrer">rtl8821ce</a></td></tr><tr><td><a href="https://www.amazon.co.jp/gp/product/B00C58G612/" target="_blank" rel="noopener noreferrer">アイ・オー・データ社 WN-AC867U</a></td><td><a href="https://www.realtek.com/ja/products/communications-network-ics/item/rtl8812au" target="_blank" rel="noopener noreferrer">rtl8812au</a></td></tr></tbody></table><p>WNPU583B は Wi-Fi/Bluetooth 両方使用できることを確認する。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ドライバのビルドインストール">ドライバのビルド・インストール<a href="#ドライバのビルドインストール" class="hash-link" aria-label="ドライバのビルド・インストール への直接リンク" title="ドライバのビルド・インストール への直接リンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="docker-コンテナの起動-ホスト側">Docker コンテナの起動 (ホスト側)<a href="#docker-コンテナの起動-ホスト側" class="hash-link" aria-label="Docker コンテナの起動 (ホスト側) への直接リンク" title="Docker コンテナの起動 (ホスト側) への直接リンク">​</a></h3><p>rtl8812au のドライバが多く迷うが、<a href="https://github.com/search?q=rtl8812au" target="_blank" rel="noopener noreferrer">GitHub での「rtl8812au」の検索結果</a>の上位のものを利用した。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/gnab/rtl8812au.git driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run --rm -it -v </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable builtin class-name" style="color:#36acaa">pwd</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">/driver:/data"</span><span class="token plain"> -w </span><span class="token string" style="color:#e3116c">"/data"</span><span class="token plain"> ubuntu:jammy /bin/bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>後述するカーネルヘッダのパッケージをインストールするためには、ホストとコンテナの OS(ディストリビューション)を合わせる必要がある。</p><p>最初<code>gcc</code>のコンテナでビルドしようとしたが、ベースとなる OS が異なるためこのパッケージがなかった。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="依存パッケージのインストール-コンテナ側">依存パッケージのインストール (コンテナ側)<a href="#依存パッケージのインストール-コンテナ側" class="hash-link" aria-label="依存パッケージのインストール (コンテナ側) への直接リンク" title="依存パッケージのインストール (コンテナ側) への直接リンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> build-essential </span><span class="token string" style="color:#e3116c">"linux-headers-</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">uname</span><span class="token string variable" style="color:#36acaa"> -r</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>なお、<code>linux-headers-*</code>のパッケージをインストールしないと下記のエラーが出る。</p><blockquote><p>make<!-- -->[1]<!-- -->: <!-- -->*<!-- -->*<!-- -->*<!-- --> /lib/modules/5.15.0-47-generic/build: No such file or directory.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ドライバのビルド-コンテナ側">ドライバのビルド (コンテナ側)<a href="#ドライバのビルド-コンテナ側" class="hash-link" aria-label="ドライバのビルド (コンテナ側) への直接リンク" title="ドライバのビルド (コンテナ側) への直接リンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">make</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ドライバのテスト-ホスト側">ドライバのテスト (ホスト側)<a href="#ドライバのテスト-ホスト側" class="hash-link" aria-label="ドライバのテスト (ホスト側) への直接リンク" title="ドライバのテスト (ホスト側) への直接リンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> insmod driver/8812au.ko</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>この状態では再起動の際にモジュールへの参照が解除されてしまう。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="インストール-ホスト側">インストール (ホスト側)<a href="#インストール-ホスト側" class="hash-link" aria-label="インストール (ホスト側) への直接リンク" title="インストール (ホスト側) への直接リンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> 8812au.ko </span><span class="token string" style="color:#e3116c">"/lib/modules/</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">uname</span><span class="token string variable" style="color:#36acaa"> -r</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">/kernel/drivers/net/wireless"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> depmod</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上記のほか、カーネルアップデートをした際に自動でビルドするには DKMS を利用する必要がある。</p><p>詳細は<a href="https://github.com/gnab/rtl8812au/" target="_blank" rel="noopener noreferrer">リポジトリの README</a>に書いてある。</p><p><code>build-essential</code>や<code>dkms</code>などのパッケージを入れる必要があるため、今回は対応しないこととする。</p><p>(別の機会に Docker を利用した方法を試したい。)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ソースコードの確認">ソースコードの確認<a href="#ソースコードの確認" class="hash-link" aria-label="ソースコードの確認 への直接リンク" title="ソースコードの確認 への直接リンク">​</a></h2><p>ここまででドングルは動作する状態にはなったが、製品への対応状況を確認するため、今回利用したリポジトリと APT リポジトリのソースコードを比較しつつ確認してみる。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ベンダー-idプロダクト-id-の確認">ベンダー ID・プロダクト ID の確認<a href="#ベンダー-idプロダクト-id-の確認" class="hash-link" aria-label="ベンダー ID・プロダクト ID の確認 への直接リンク" title="ベンダー ID・プロダクト ID の確認 への直接リンク">​</a></h3><p>ソースコードを探るにあたり、製品の ID を確認する。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">lsusb </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> -i wn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Bus 001 Device 013: ID 0bda:0823 Realtek Semiconductor Corp. WNPU583B</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Bus 001 Device 012: ID 04bb:0952 I-O Data Device, Inc. WN-AC867U</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>0bda:0823</code>や<code>04bb:0952</code>がベンダー ID(<code>idVendor</code>)とプロダクト ID(<code>idProduct</code>)の値のため、これを利用してソースコードを検索する。
ベンダー ID を含めるとヒット件数が多いため、プロダクト ID を利用して検索を行う。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="今回利用したリポジトリのソースコード">今回利用したリポジトリのソースコード<a href="#今回利用したリポジトリのソースコード" class="hash-link" aria-label="今回利用したリポジトリのソースコード への直接リンク" title="今回利用したリポジトリのソースコード への直接リンク">​</a></h3><p><a href="https://github.com/gnab/rtl8812au.git" target="_blank" rel="noopener noreferrer">https://github.com/gnab/rtl8812au.git</a>のソースコード内から関連する記述を確認する。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> -iP </span><span class="token string" style="color:#e3116c">'0x(0823|0952)'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; os_dep/linux/usb_intf.c:        {USB_DEVICE(0x04BB, 0x0952),.driver_info = RTL8812}, /* I-O DATA - Edimax */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; os_dep/linux/usb_intf.c:        {USB_DEVICE(0x0bda, 0x0823),.driver_info = RTL8821}, /* I-O DATA - WNPU583B */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="apt-リポジトリのソースコード">APT リポジトリのソースコード<a href="#apt-リポジトリのソースコード" class="hash-link" aria-label="APT リポジトリのソースコード への直接リンク" title="APT リポジトリのソースコード への直接リンク">​</a></h3><p>ホスト環境の設定を変えたくなかったのでコンテナ環境でソースコードを取得する</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 何かしらエディタをインストール</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># deb-src のコメントアウトを解除する</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">busybox </span><span class="token function" style="color:#d73a49">vi</span><span class="token plain"> /etc/apt/sources.list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 関連するパッケージを検索</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> search --names-only </span><span class="token string" style="color:#e3116c">'rtl88[21]{2}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Sorting... Done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Full Text Search... Done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8812au-dkms/jammy,jammy 4.3.8.12175.20140902+dfsg-0ubuntu15 all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   dkms source for the r8812au network driver</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8821ce-dkms/jammy,jammy 5.5.2.1-0ubuntu10 all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   DKMS source for the Realtek 8821C PCIe Wi-Fi driver</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上記のパッケージ検索結果から<code>rtl8812au-dkms</code>と<code>rtl8821ce-dkms</code>を確認することにする。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ソースコードのダウンロード</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token builtin class-name">source</span><span class="token plain"> rtl8812au-dkms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下記のメッセージが出てきたが、今回は<code>apt source</code>でダウンロードしたものを確認する。</p><blockquote><p>Picking 'rtl8812au' as source package instead of 'rtl8812au-dkms'<br>
<!-- -->NOTICE: 'rtl8812au' packaging is maintained in the 'Git' version control system at:<br>
<a href="https://github.com/rsalveti/rtl8812au.git" target="_blank" rel="noopener noreferrer">https://github.com/rsalveti/rtl8812au.git</a><br>
<!-- -->Please use:<br>
<!-- -->git clone <a href="https://github.com/rsalveti/rtl8812au.git" target="_blank" rel="noopener noreferrer">https://github.com/rsalveti/rtl8812au.git</a><br>
<!-- -->to retrieve the latest (possibly unreleased) updates to the package.</p></blockquote><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token builtin class-name">source</span><span class="token plain"> rtl8821ce-dkms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下記のメッセージが出てきたが、こちらも<code>apt source</code>でダウンロードしたものを確認する。</p><blockquote><p>Picking 'rtl8821ce' as source package instead of 'rtl8821ce-dkms'<br>
<!-- -->NOTICE: 'rtl8821ce' packaging is maintained in the 'Git' version control system at:<br>
<a href="https://git.launchpad.net/~canonical-hwe-team/ubuntu/+source/rtl8821ce-dkms/+git/rtl8821ce-dkms" target="_blank" rel="noopener noreferrer">https://git.launchpad.net/~canonical-hwe-team/ubuntu/+source/rtl8821ce-dkms/+git/rtl8821ce-dkms</a><br>
<!-- -->Please use:<br>
<!-- -->git clone <a href="https://git.launchpad.net/~canonical-hwe-team/ubuntu/+source/rtl8821ce-dkms/+git/rtl8821ce-dkms" target="_blank" rel="noopener noreferrer">https://git.launchpad.net/~canonical-hwe-team/ubuntu/+source/rtl8821ce-dkms/+git/rtl8821ce-dkms</a><br>
<!-- -->to retrieve the latest (possibly unreleased) updates to the package.</p></blockquote><p>ダウンロードしたソースコードから関連する記述を検索する。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ダウンロードされたファイルの確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8812au-4.3.8.12175.20140902+dfsg</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8812au_4.3.8.12175.20140902+dfsg-0ubuntu15.debian.tar.xz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8812au_4.3.8.12175.20140902+dfsg-0ubuntu15.dsc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8812au_4.3.8.12175.20140902+dfsg.orig.tar.gz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8821ce-5.5.2.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8821ce_5.5.2.1-0ubuntu10.debian.tar.xz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8821ce_5.5.2.1-0ubuntu10.dsc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8821ce_5.5.2.1.orig.tar.gz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 関連する記述を確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> -name </span><span class="token string" style="color:#e3116c">"*.c"</span><span class="token plain"> -print0 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xargs</span><span class="token plain"> -0 </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> -iP </span><span class="token string" style="color:#e3116c">'0x(0823|0952)'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; ./rtl8812au-4.3.8.12175.20140902+dfsg/.pc/0009-usb_intf-extending-compatible-vendor-list.patch/os_dep/linux/usb_intf.c: {USB_DEVICE(0x04BB, 0x0952),.driver_info = RTL8812}, /* I-O DATA - Edimax */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; ./rtl8812au-4.3.8.12175.20140902+dfsg/.pc/0004-Adding-additional-compatible-devices.patch/os_dep/linux/usb_intf.c:  {USB_DEVICE(0x04BB, 0x0952),.driver_info = RTL8812}, /* I-O DATA - Edimax */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; ./rtl8812au-4.3.8.12175.20140902+dfsg/os_dep/linux/usb_intf.c:  {USB_DEVICE(0x04BB, 0x0952),.driver_info = RTL8812}, /* I-O DATA - Edimax *</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>依存パッケージが多く入れたくないため確認していないが、上記からの予想として、WN-AC867U であれば<code>rtl8812au</code>のパッケージをインストールすれば利用できる可能性がある。</p><p>WNPU583B に関連する部分はヒットしないため動作するか不明。</p><p>(過去の経験では Kubuntu 20.04 において <code>rtl8821ce-dkms</code>をインストールすることで Bluetooth だけは利用できた。)</p>]]></content:encoded>
            <category>ubuntu</category>
            <category>linux</category>
            <category>wifi</category>
        </item>
        <item>
            <title><![CDATA[【Linux】Raspberry Pi 4のSambaサーバへiPhoneの純正アプリから接続する]]></title>
            <link>https://notes.ogumaru.dev/2022/09/10/samba-on-raspberrypi-from-ios</link>
            <guid>https://notes.ogumaru.dev/2022/09/10/samba-on-raspberrypi-from-ios</guid>
            <pubDate>Sat, 10 Sep 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[概要]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要 への直接リンク" title="概要 への直接リンク">​</a></h2><p>Raspberry Pi 4 を利用して LAN 内に Samba サーバを構築し、iPhone に標準でインストールされている「ファイル」アプリからの接続を行う</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="環境">環境<a href="#環境" class="hash-link" aria-label="環境 への直接リンク" title="環境 への直接リンク">​</a></h2><table><thead><tr><th>項目</th><th>内容</th></tr></thead><tbody><tr><td>クライアント機種</td><td>iPhone 8 Plus</td></tr><tr><td>クライアント OS</td><td>iOS 15.6.1</td></tr><tr><td>サーバ機種</td><td>Raspberry Pi 4 Model B</td></tr></tbody></table><p>Raspberry Pi OS はバージョンがないらしいため下記で確認</p><p>(ベータ版で出た 64-bit の OS を入れた記憶がある)</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">uname</span><span class="token plain"> -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Linux raspberrypi 5.10.103-v8+ #1529 SMP PREEMPT Tue Mar 8 12:26:46 GMT 2022 aarch64 GNU/Linux</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lsb_release -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; No LSB modules are available.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Distributor ID: Debian</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Description:    Debian GNU/Linux 10 (buster)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Release:    10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Codename:   buster</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">samba --version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Version 4.9.5-Debian</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="準備">準備<a href="#準備" class="hash-link" aria-label="準備 への直接リンク" title="準備 への直接リンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="samba-パッケージ">Samba パッケージ<a href="#samba-パッケージ" class="hash-link" aria-label="Samba パッケージ への直接リンク" title="Samba パッケージ への直接リンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> samba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># iOS や macOSでも利用する場合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> samba-vfs-modules</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ユーザ">ユーザ<a href="#ユーザ" class="hash-link" aria-label="ユーザ への直接リンク" title="ユーザ への直接リンク">​</a></h3><p>ここは<a href="https://wiki.archlinux.jp/index.php/Samba" target="_blank" rel="noopener noreferrer">Samba - ArchWiki (wiki.archlinux.jp)</a>を参考に設定した</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Sambaユーザの追加</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> pdbedit -a </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">whoami</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># `usershare path` で指定する`/var/lib/samba/usershares` にアクセスするため</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># (所有者:グループ が root:sambashare になっている)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> gpasswd sambashare -a </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">whoami</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>グループ設定を反映させるため再ログインする</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ファイアウォール">ファイアウォール<a href="#ファイアウォール" class="hash-link" aria-label="ファイアウォール への直接リンク" title="ファイアウォール への直接リンク">​</a></h3><p><a href="https://www.samba.org/~tpot/articles/firewall.html" target="_blank" rel="noopener noreferrer">Firewalling Samba (www.samba.org)</a>によると、許可するのは下記</p><table><thead><tr><th>プロトコル</th><th>ポート</th></tr></thead><tbody><tr><td>UDP</td><td>137</td></tr><tr><td>UDP</td><td>138</td></tr><tr><td>TCP</td><td>139</td></tr><tr><td>TCP</td><td>445</td></tr></tbody></table><p><code>ufw</code>を利用していれば下記</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Samba のルールがあれば利用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> ufw app list </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> -i samba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> ufw allow samba</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="samba-の設定">Samba の設定<a href="#samba-の設定" class="hash-link" aria-label="Samba の設定 への直接リンク" title="Samba の設定 への直接リンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="グローバル設定ファイル">グローバル設定ファイル<a href="#グローバル設定ファイル" class="hash-link" aria-label="グローバル設定ファイル への直接リンク" title="グローバル設定ファイル への直接リンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 設定ファイルのバックアップ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> -a /etc/samba/smb.conf</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">,.</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">date</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">'+%Y-%m-%d_%H%M%S'</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain">.bak</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 下記差分を追記</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudoedit /etc/samba/smb.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[global]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   usershare path = /var/lib/samba/usershares</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   # For supporting iOS / macOS</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   vfs objects = fruit streams_xattr</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   fruit:metadata = stream</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   fruit:model = MacSamba</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   fruit:posix_rename = yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   fruit:veto_appledouble = no</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   fruit:nfs_aces = no</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   fruit:wipe_intentionally_left_blank_rfork = yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   fruit:delete_empty_adfiles = yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上記の<code>vfs</code>や<code>fruit</code>の設定がないと、保存の際に「操作を完了できませんでした」「属性が見つかりません」のようなエラーメッセージが表示される</p><p>VFS 関連の設定内容については下記ページのものを利用した</p><p><a href="https://wiki.samba.org/index.php/Configure_Samba_to_Work_Better_with_Mac_OS_X" target="_blank" rel="noopener noreferrer">Configure Samba to Work Better with Mac OS X - SambaWiki (wiki.samba.org)</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="共有設定ファイル">共有設定ファイル<a href="#共有設定ファイル" class="hash-link" aria-label="共有設定ファイル への直接リンク" title="共有設定ファイル への直接リンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 共有するディレクトリの作成</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p ~/share</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 共有設定ファイルの作成</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net usershare </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"share"</span><span class="token plain"> ~/share/ </span><span class="token string" style="color:#e3116c">"samba share"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">whoami</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">:f"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>権限の設定については
<a href="https://www.samba.org/samba/docs/current/man-html/net.8.html" target="_blank" rel="noopener noreferrer">net (www.samba.org)</a>などを参考に指定する</p><blockquote><p>The definition of a user defined share acl is: "user:permission", where user is a valid username on the system and permission can be "F", "R", or "D". "F" stands for "full permissions", ie. read and write permissions. "D" stands for "deny" for a user, ie. prevent this user from accessing this share. "R" stands for "read only", ie. only allow read access to this share (no creation of new files or directories or writing to files).</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="設定の反映">設定の反映<a href="#設定の反映" class="hash-link" aria-label="設定の反映 への直接リンク" title="設定の反映 への直接リンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl reload smbd.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="接続">接続<a href="#接続" class="hash-link" aria-label="接続 への直接リンク" title="接続 への直接リンク">​</a></h2><p>mDNS で名前解決ができれば、同じネットワークにつないだ上で iOS の「ファイル」から</p><ol><li>[ブラウズ]</li><li>右上の丸で囲まれた三点(…)</li><li>[サーバへ接続]</li><li><code>raspberrypi.local</code>など</li><li>[登録ユーザ]<!-- --> を選択</li><li>Raspberry Pi のユーザ情報を入力</li></ol><p>で接続できる</p><p>例えば写真は共有から「"ファイル"に保存」から上記フォルダを選択することで保存できる</p><p>当初 VFS 関連(<code>vfs</code>や<code>fruit</code>)を設定しておらず、ここで保存ができずに困ってかなり時間を使った</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="パフォーマンスについて">パフォーマンスについて<a href="#パフォーマンスについて" class="hash-link" aria-label="パフォーマンスについて への直接リンク" title="パフォーマンスについて への直接リンク">​</a></h2><p>1MB の画像をコピーするのに 体感で 1 秒程度</p><p>10MB の動画をコピーするのに 体感で 2 〜 3 秒程度</p><p>SSD を接続した USB ブートで利用しているため、Raspberry Pi 環境の中では比較的 I/O は早いはず</p><p>microSD 環境ではもう少し遅いかもしれない</p>]]></content:encoded>
            <category>ubuntu</category>
            <category>linux</category>
            <category>raspberrypi</category>
            <category>samba</category>
            <category>ios</category>
        </item>
        <item>
            <title><![CDATA[【JavaScript】Prismaの単純なレコードを値の配列として取得する]]></title>
            <link>https://notes.ogumaru.dev/2022/08/13/proxy-prisma-records</link>
            <guid>https://notes.ogumaru.dev/2022/08/13/proxy-prisma-records</guid>
            <pubDate>Sat, 13 Aug 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[概要]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要 への直接リンク" title="概要 への直接リンク">​</a></h2><p>Prisma を利用して、 1:N のリレーションを持つ単純なレコードの値を配列として取得する。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="結論">結論<a href="#結論" class="hash-link" aria-label="結論 への直接リンク" title="結論 への直接リンク">​</a></h2><p><code>Proxy</code>を利用する。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="実行環境">実行環境<a href="#実行環境" class="hash-link" aria-label="実行環境 への直接リンク" title="実行環境 への直接リンク">​</a></h2><table><thead><tr><th>実行環境</th><th>バージョン</th></tr></thead><tbody><tr><td>node</td><td>v16.15.0</td></tr><tr><td>prisma</td><td>4.2.1</td></tr><tr><td>@prisma/client</td><td>4.2.1</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="やりたいこと">やりたいこと<a href="#やりたいこと" class="hash-link" aria-label="やりたいこと への直接リンク" title="やりたいこと への直接リンク">​</a></h2><p><img loading="lazy" alt="LeavesとBranchesのER図" src="data:image/svg+xml;base64,PHN2ZyBhcmlhLWxhYmVsbGVkYnk9ImNoYXJ0LXRpdGxlLWdyYXBoLWRpdiBjaGFydC1kZXNjLWdyYXBoLWRpdiIgcm9sZT0iaW1nIiB2aWV3Qm94PSIwIDAgMTQwIDI1MSIgc3R5bGU9Im1heC13aWR0aDogMTQwcHg7IiBoZWlnaHQ9IjI1MSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTAwJSIgaWQ9ImdyYXBoLWRpdiIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxzdHlsZT5AaW1wb3J0IHVybCgiaHR0cHM6Ly9jZG5qcy5jbG91ZGZsYXJlLmNvbS9hamF4L2xpYnMvZm9udC1hd2Vzb21lLzUuMTUuMi9jc3MvYWxsLm1pbi5jc3MiKTsnPC9zdHlsZT48dGl0bGUgaWQ9ImNoYXJ0LXRpdGxlLWdyYXBoLWRpdiI+PC90aXRsZT48ZGVzYyBpZD0iY2hhcnQtZGVzYy1ncmFwaC1kaXYiPjwvZGVzYz48c3R5bGU+I2dyYXBoLWRpdiB7Zm9udC1mYW1pbHk6InRyZWJ1Y2hldCBtcyIsdmVyZGFuYSxhcmlhbCxzYW5zLXNlcmlmO2ZvbnQtc2l6ZToxNnB4O2ZpbGw6IzMzMzt9I2dyYXBoLWRpdiAuZXJyb3ItaWNvbntmaWxsOiM1NTIyMjI7fSNncmFwaC1kaXYgLmVycm9yLXRleHR7ZmlsbDojNTUyMjIyO3N0cm9rZTojNTUyMjIyO30jZ3JhcGgtZGl2IC5lZGdlLXRoaWNrbmVzcy1ub3JtYWx7c3Ryb2tlLXdpZHRoOjJweDt9I2dyYXBoLWRpdiAuZWRnZS10aGlja25lc3MtdGhpY2t7c3Ryb2tlLXdpZHRoOjMuNXB4O30jZ3JhcGgtZGl2IC5lZGdlLXBhdHRlcm4tc29saWR7c3Ryb2tlLWRhc2hhcnJheTowO30jZ3JhcGgtZGl2IC5lZGdlLXBhdHRlcm4tZGFzaGVke3N0cm9rZS1kYXNoYXJyYXk6Mzt9I2dyYXBoLWRpdiAuZWRnZS1wYXR0ZXJuLWRvdHRlZHtzdHJva2UtZGFzaGFycmF5OjI7fSNncmFwaC1kaXYgLm1hcmtlcntmaWxsOiMzMzMzMzM7c3Ryb2tlOiMzMzMzMzM7fSNncmFwaC1kaXYgLm1hcmtlci5jcm9zc3tzdHJva2U6IzMzMzMzMzt9I2dyYXBoLWRpdiBzdmd7Zm9udC1mYW1pbHk6InRyZWJ1Y2hldCBtcyIsdmVyZGFuYSxhcmlhbCxzYW5zLXNlcmlmO2ZvbnQtc2l6ZToxNnB4O30jZ3JhcGgtZGl2IC5lbnRpdHlCb3h7ZmlsbDojRUNFQ0ZGO3N0cm9rZTojOTM3MERCO30jZ3JhcGgtZGl2IC5hdHRyaWJ1dGVCb3hPZGR7ZmlsbDojZmZmZmZmO3N0cm9rZTojOTM3MERCO30jZ3JhcGgtZGl2IC5hdHRyaWJ1dGVCb3hFdmVue2ZpbGw6I2YyZjJmMjtzdHJva2U6IzkzNzBEQjt9I2dyYXBoLWRpdiAucmVsYXRpb25zaGlwTGFiZWxCb3h7ZmlsbDpoc2woODAsIDEwMCUsIDk2LjI3NDUwOTgwMzklKTtvcGFjaXR5OjAuNztiYWNrZ3JvdW5kLWNvbG9yOmhzbCg4MCwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpO30jZ3JhcGgtZGl2IC5yZWxhdGlvbnNoaXBMYWJlbEJveCByZWN0e29wYWNpdHk6MC41O30jZ3JhcGgtZGl2IC5yZWxhdGlvbnNoaXBMaW5le3N0cm9rZTojMzMzMzMzO30jZ3JhcGgtZGl2IDpyb290ey0tbWVybWFpZC1mb250LWZhbWlseToidHJlYnVjaGV0IG1zIix2ZXJkYW5hLGFyaWFsLHNhbnMtc2VyaWY7fTwvc3R5bGU+PGc+PC9nPjxkZWZzPjxtYXJrZXIgb3JpZW50PSJhdXRvIiBtYXJrZXJIZWlnaHQ9IjE4IiBtYXJrZXJXaWR0aD0iMTgiIHJlZlk9IjkiIHJlZlg9IjAiIGlkPSJPTkxZX09ORV9TVEFSVCI+PHBhdGggZD0iTTksMCBMOSwxOCBNMTUsMCBMMTUsMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iZ3JheSI+PC9wYXRoPjwvbWFya2VyPjwvZGVmcz48ZGVmcz48bWFya2VyIG9yaWVudD0iYXV0byIgbWFya2VySGVpZ2h0PSIxOCIgbWFya2VyV2lkdGg9IjE4IiByZWZZPSI5IiByZWZYPSIxOCIgaWQ9Ik9OTFlfT05FX0VORCI+PHBhdGggZD0iTTMsMCBMMywxOCBNOSwwIEw5LDE4IiBmaWxsPSJub25lIiBzdHJva2U9ImdyYXkiPjwvcGF0aD48L21hcmtlcj48L2RlZnM+PGRlZnM+PG1hcmtlciBvcmllbnQ9ImF1dG8iIG1hcmtlckhlaWdodD0iMTgiIG1hcmtlcldpZHRoPSIzMCIgcmVmWT0iOSIgcmVmWD0iMCIgaWQ9IlpFUk9fT1JfT05FX1NUQVJUIj48Y2lyY2xlIHI9IjYiIGN5PSI5IiBjeD0iMjEiIGZpbGw9IndoaXRlIiBzdHJva2U9ImdyYXkiPjwvY2lyY2xlPjxwYXRoIGQ9Ik05LDAgTDksMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iZ3JheSI+PC9wYXRoPjwvbWFya2VyPjwvZGVmcz48ZGVmcz48bWFya2VyIG9yaWVudD0iYXV0byIgbWFya2VySGVpZ2h0PSIxOCIgbWFya2VyV2lkdGg9IjMwIiByZWZZPSI5IiByZWZYPSIzMCIgaWQ9IlpFUk9fT1JfT05FX0VORCI+PGNpcmNsZSByPSI2IiBjeT0iOSIgY3g9IjkiIGZpbGw9IndoaXRlIiBzdHJva2U9ImdyYXkiPjwvY2lyY2xlPjxwYXRoIGQ9Ik0yMSwwIEwyMSwxOCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJncmF5Ij48L3BhdGg+PC9tYXJrZXI+PC9kZWZzPjxkZWZzPjxtYXJrZXIgb3JpZW50PSJhdXRvIiBtYXJrZXJIZWlnaHQ9IjM2IiBtYXJrZXJXaWR0aD0iNDUiIHJlZlk9IjE4IiByZWZYPSIxOCIgaWQ9Ik9ORV9PUl9NT1JFX1NUQVJUIj48cGF0aCBkPSJNMCwxOCBRIDE4LDAgMzYsMTggUSAxOCwzNiAwLDE4IE00Miw5IEw0MiwyNyIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJncmF5Ij48L3BhdGg+PC9tYXJrZXI+PC9kZWZzPjxkZWZzPjxtYXJrZXIgb3JpZW50PSJhdXRvIiBtYXJrZXJIZWlnaHQ9IjM2IiBtYXJrZXJXaWR0aD0iNDUiIHJlZlk9IjE4IiByZWZYPSIyNyIgaWQ9Ik9ORV9PUl9NT1JFX0VORCI+PHBhdGggZD0iTTMsOSBMMywyNyBNOSwxOCBRMjcsMCA0NSwxOCBRMjcsMzYgOSwxOCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJncmF5Ij48L3BhdGg+PC9tYXJrZXI+PC9kZWZzPjxkZWZzPjxtYXJrZXIgb3JpZW50PSJhdXRvIiBtYXJrZXJIZWlnaHQ9IjM2IiBtYXJrZXJXaWR0aD0iNTciIHJlZlk9IjE4IiByZWZYPSIxOCIgaWQ9IlpFUk9fT1JfTU9SRV9TVEFSVCI+PGNpcmNsZSByPSI2IiBjeT0iMTgiIGN4PSI0OCIgZmlsbD0id2hpdGUiIHN0cm9rZT0iZ3JheSI+PC9jaXJjbGU+PHBhdGggZD0iTTAsMTggUTE4LDAgMzYsMTggUTE4LDM2IDAsMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iZ3JheSI+PC9wYXRoPjwvbWFya2VyPjwvZGVmcz48ZGVmcz48bWFya2VyIG9yaWVudD0iYXV0byIgbWFya2VySGVpZ2h0PSIzNiIgbWFya2VyV2lkdGg9IjU3IiByZWZZPSIxOCIgcmVmWD0iMzkiIGlkPSJaRVJPX09SX01PUkVfRU5EIj48Y2lyY2xlIHI9IjYiIGN5PSIxOCIgY3g9IjkiIGZpbGw9IndoaXRlIiBzdHJva2U9ImdyYXkiPjwvY2lyY2xlPjxwYXRoIGQ9Ik0yMSwxOCBRMzksMCA1NywxOCBRMzksMzYgMjEsMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iZ3JheSI+PC9wYXRoPjwvbWFya2VyPjwvZGVmcz48cGF0aCBtYXJrZXItc3RhcnQ9InVybCgjWkVST19PUl9NT1JFX1NUQVJUKSIgbWFya2VyLWVuZD0idXJsKCNPTkxZX09ORV9FTkQpIiBmaWxsPSJub25lIiBzdHJva2U9ImdyYXkiIGQ9Ik03MCw4Nkw3MCw5NC4zMzMzMzMzMzMzMzMzM0M3MCwxMDIuNjY2NjY2NjY2NjY2NjcsNzAsMTE5LjMzMzMzMzMzMzMzMzMzLDcwLDEzNkM3MCwxNTIuNjY2NjY2NjY2NjY2NjYsNzAsMTY5LjMzMzMzMzMzMzMzMzM0LDcwLDE3Ny42NjY2NjY2NjY2NjY2Nkw3MCwxODYiIGNsYXNzPSJlciByZWxhdGlvbnNoaXBMaW5lIj48L3BhdGg+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjAsMTg2ICkiIGlkPSJCcmFuY2hlcyI+PHJlY3QgaGVpZ2h0PSI0NSIgd2lkdGg9IjEwMCIgeT0iMCIgeD0iMCIgc3Ryb2tlPSJncmF5IiBmaWxsLW9wYWNpdHk9IjEwMCUiIGZpbGw9ImhvbmV5ZGV3IiBjbGFzcz0iZXIgZW50aXR5Qm94Ij48L3JlY3Q+PHRleHQgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNTAsMTIpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEycHgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktQnJhbmNoZXMiIGNsYXNzPSJlciBlbnRpdHlMYWJlbCI+QnJhbmNoZXM8L3RleHQ+PHJlY3QgaGVpZ2h0PSIyMSIgd2lkdGg9IjMzLjY0NDcwNDE4Mjk0MjcxIiB5PSIyNCIgeD0iMCIgc3Ryb2tlPSJncmF5IiBmaWxsLW9wYWNpdHk9IjEwMCUiIGZpbGw9ImhvbmV5ZGV3IiBjbGFzcz0iZXIgYXR0cmlidXRlQm94T2RkIj48L3JlY3Q+PHRleHQgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNSwzNC41KSIgc3R5bGU9ImZvbnQtZmFtaWx5OiAmcXVvdDt0cmVidWNoZXQgbXMmcXVvdDssIHZlcmRhbmEsIGFyaWFsLCBzYW5zLXNlcmlmOzsgZm9udC1zaXplOiAxMC4ycHgiIHRleHQtYW5jaG9yPSJsZWZ0IiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB5PSIwIiB4PSIwIiBpZD0iZW50aXR5LUJyYW5jaGVzLWF0dHItMS10eXBlIiBjbGFzcz0iZXIgZW50aXR5TGFiZWwiPkludDwvdGV4dD48cmVjdCBoZWlnaHQ9IjIxIiB3aWR0aD0iMzAuNDExODI0NTQ0MjcwODM2IiB5PSIyNCIgeD0iMzMuNjQ0NzA0MTgyOTQyNzEiIHN0cm9rZT0iZ3JheSIgZmlsbC1vcGFjaXR5PSIxMDAlIiBmaWxsPSJob25leWRldyIgY2xhc3M9ImVyIGF0dHJpYnV0ZUJveE9kZCI+PC9yZWN0Pjx0ZXh0IHRyYW5zZm9ybT0idHJhbnNsYXRlKDM4LjY0NDcwNDE4Mjk0MjcxLDM0LjUpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEwLjJweCIgdGV4dC1hbmNob3I9ImxlZnQiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktQnJhbmNoZXMtYXR0ci0xLW5hbWUiIGNsYXNzPSJlciBlbnRpdHlMYWJlbCI+aWQ8L3RleHQ+PHJlY3QgaGVpZ2h0PSIyMSIgd2lkdGg9IjM1Ljk0MzQ3MTI3Mjc4NjQ2IiB5PSIyNCIgeD0iNjQuMDU2NTI4NzI3MjEzNTUiIHN0cm9rZT0iZ3JheSIgZmlsbC1vcGFjaXR5PSIxMDAlIiBmaWxsPSJob25leWRldyIgY2xhc3M9ImVyIGF0dHJpYnV0ZUJveE9kZCI+PC9yZWN0Pjx0ZXh0IHRyYW5zZm9ybT0idHJhbnNsYXRlKDY5LjA1NjUyODcyNzIxMzU1LDM0LjUpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEwLjJweCIgdGV4dC1hbmNob3I9ImxlZnQiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktQnJhbmNoZXMtYXR0ci0xLWtleSIgY2xhc3M9ImVyIGVudGl0eUxhYmVsIj5QSzwvdGV4dD48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjAsMjAgKSIgaWQ9IkxlYXZlcyI+PHJlY3QgaGVpZ2h0PSI2NiIgd2lkdGg9IjEwMCIgeT0iMCIgeD0iMCIgc3Ryb2tlPSJncmF5IiBmaWxsLW9wYWNpdHk9IjEwMCUiIGZpbGw9ImhvbmV5ZGV3IiBjbGFzcz0iZXIgZW50aXR5Qm94Ij48L3JlY3Q+PHRleHQgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNTAsMTIpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEycHgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktTGVhdmVzIiBjbGFzcz0iZXIgZW50aXR5TGFiZWwiPkxlYXZlczwvdGV4dD48cmVjdCBoZWlnaHQ9IjIxIiB3aWR0aD0iMzguNDcwMTQzNjM2MDY3NzEiIHk9IjI0IiB4PSIwIiBzdHJva2U9ImdyYXkiIGZpbGwtb3BhY2l0eT0iMTAwJSIgZmlsbD0iaG9uZXlkZXciIGNsYXNzPSJlciBhdHRyaWJ1dGVCb3hPZGQiPjwvcmVjdD48dGV4dCB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1LDM0LjUpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEwLjJweCIgdGV4dC1hbmNob3I9ImxlZnQiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktTGVhdmVzLWF0dHItMS10eXBlIiBjbGFzcz0iZXIgZW50aXR5TGFiZWwiPkludDwvdGV4dD48cmVjdCBoZWlnaHQ9IjIxIiB3aWR0aD0iMzYuMjExNzgxODE5NjYxNDYiIHk9IjI0IiB4PSIzOC40NzAxNDM2MzYwNjc3MSIgc3Ryb2tlPSJncmF5IiBmaWxsLW9wYWNpdHk9IjEwMCUiIGZpbGw9ImhvbmV5ZGV3IiBjbGFzcz0iZXIgYXR0cmlidXRlQm94T2RkIj48L3JlY3Q+PHRleHQgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNDMuNDcwMTQzNjM2MDY3NzEsMzQuNSkiIHN0eWxlPSJmb250LWZhbWlseTogJnF1b3Q7dHJlYnVjaGV0IG1zJnF1b3Q7LCB2ZXJkYW5hLCBhcmlhbCwgc2Fucy1zZXJpZjs7IGZvbnQtc2l6ZTogMTAuMnB4IiB0ZXh0LWFuY2hvcj0ibGVmdCIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgeT0iMCIgeD0iMCIgaWQ9ImVudGl0eS1MZWF2ZXMtYXR0ci0xLW5hbWUiIGNsYXNzPSJlciBlbnRpdHlMYWJlbCI+aWQ8L3RleHQ+PHJlY3QgaGVpZ2h0PSIyMSIgd2lkdGg9IjI1LjMxODA3NDU0NDI3MDgzMiIgeT0iMjQiIHg9Ijc0LjY4MTkyNTQ1NTcyOTE3IiBzdHJva2U9ImdyYXkiIGZpbGwtb3BhY2l0eT0iMTAwJSIgZmlsbD0iaG9uZXlkZXciIGNsYXNzPSJlciBhdHRyaWJ1dGVCb3hPZGQiPjwvcmVjdD48dGV4dCB0cmFuc2Zvcm09InRyYW5zbGF0ZSg3OS42ODE5MjU0NTU3MjkxNywzNC41KSIgc3R5bGU9ImZvbnQtZmFtaWx5OiAmcXVvdDt0cmVidWNoZXQgbXMmcXVvdDssIHZlcmRhbmEsIGFyaWFsLCBzYW5zLXNlcmlmOzsgZm9udC1zaXplOiAxMC4ycHgiIHRleHQtYW5jaG9yPSJsZWZ0IiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB5PSIwIiB4PSIwIiBpZD0iZW50aXR5LUxlYXZlcy1hdHRyLTEta2V5IiBjbGFzcz0iZXIgZW50aXR5TGFiZWwiPlBLPC90ZXh0PjxyZWN0IGhlaWdodD0iMjEiIHdpZHRoPSIzOC40NzAxNDM2MzYwNjc3MSIgeT0iNDUiIHg9IjAiIHN0cm9rZT0iZ3JheSIgZmlsbC1vcGFjaXR5PSIxMDAlIiBmaWxsPSJob25leWRldyIgY2xhc3M9ImVyIGF0dHJpYnV0ZUJveEV2ZW4iPjwvcmVjdD48dGV4dCB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1LDU1LjUpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEwLjJweCIgdGV4dC1hbmNob3I9ImxlZnQiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktTGVhdmVzLWF0dHItMi10eXBlIiBjbGFzcz0iZXIgZW50aXR5TGFiZWwiPlN0cmluZzwvdGV4dD48cmVjdCBoZWlnaHQ9IjIxIiB3aWR0aD0iMzYuMjExNzgxODE5NjYxNDYiIHk9IjQ1IiB4PSIzOC40NzAxNDM2MzYwNjc3MSIgc3Ryb2tlPSJncmF5IiBmaWxsLW9wYWNpdHk9IjEwMCUiIGZpbGw9ImhvbmV5ZGV3IiBjbGFzcz0iZXIgYXR0cmlidXRlQm94RXZlbiI+PC9yZWN0Pjx0ZXh0IHRyYW5zZm9ybT0idHJhbnNsYXRlKDQzLjQ3MDE0MzYzNjA2NzcxLDU1LjUpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEwLjJweCIgdGV4dC1hbmNob3I9ImxlZnQiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktTGVhdmVzLWF0dHItMi1uYW1lIiBjbGFzcz0iZXIgZW50aXR5TGFiZWwiPnZhbHVlPC90ZXh0PjxyZWN0IGhlaWdodD0iMjEiIHdpZHRoPSIyNS4zMTgwNzQ1NDQyNzA4MzIiIHk9IjQ1IiB4PSI3NC42ODE5MjU0NTU3MjkxNyIgc3Ryb2tlPSJncmF5IiBmaWxsLW9wYWNpdHk9IjEwMCUiIGZpbGw9ImhvbmV5ZGV3IiBjbGFzcz0iZXIgYXR0cmlidXRlQm94RXZlbiI+PC9yZWN0Pjx0ZXh0IHRyYW5zZm9ybT0idHJhbnNsYXRlKDc5LjY4MTkyNTQ1NTcyOTE3LDU1LjUpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEwLjJweCIgdGV4dC1hbmNob3I9ImxlZnQiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktTGVhdmVzLWF0dHItMi1rZXkiIGNsYXNzPSJlciBlbnRpdHlMYWJlbCI+PC90ZXh0PjwvZz48cmVjdCBmaWxsLW9wYWNpdHk9Ijg1JSIgZmlsbD0id2hpdGUiIGhlaWdodD0iMTQiIHdpZHRoPSIzNi43MDMxMjUiIHk9IjEyOSIgeD0iNTEuNjQ4NDM3NSIgY2xhc3M9ImVyIHJlbGF0aW9uc2hpcExhYmVsQm94Ij48L3JlY3Q+PHRleHQgc3R5bGU9ImZvbnQtZmFtaWx5OiAmcXVvdDt0cmVidWNoZXQgbXMmcXVvdDssIHZlcmRhbmEsIGFyaWFsLCBzYW5zLXNlcmlmOzsgZm9udC1zaXplOiAxMnB4IiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB5PSIxMzYiIHg9IjcwIiBpZD0icmVsMTIiIGNsYXNzPSJlciByZWxhdGlvbnNoaXBMYWJlbCI+YnJhbmNoPC90ZXh0Pjwvc3ZnPg==" title="単純な1:NのER図" width="140" height="251" class="img_ev3q"></p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>schema.prisma</summary><div><div class="collapsibleContent_i85q"><div class="language-prisma codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-prisma codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">generator client {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provider = "prisma-client-js"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">datasource db {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provider = "sqlite"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  url      = env("DATABASE_URL")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model Branches {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id     Int      @id @default(autoincrement())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  leaves Leaves[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model Leaves {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id       Int      @id @default(autoincrement())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  branch   Branches @relation(fields: [branchId], references: [id])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  branchId Int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value    String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>上図の単純な <code>Branches</code>:<code>Leaves</code> = 1:N となるテーブルに対して、Prisma で取得したオブジェクトに対し、</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">branches</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">leaves</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"hoge"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"huga"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>のようにプロパティアクセスで子となるレコードの値のみを取得したい。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="実際の挙動">実際の挙動<a href="#実際の挙動" class="hash-link" aria-label="実際の挙動 への直接リンク" title="実際の挙動 への直接リンク">​</a></h2><p>Prisma ではレコードはオブジェクトとなる。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> branch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> prisma</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">branches</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findFirstOrThrow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> leaves</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> branch</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>とすると下記のような形でレコードが返される。</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"leaves"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"branchId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"value"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"hoge"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"branchId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"value"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"huga"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="proxy-を利用したルーティング">Proxy を利用したルーティング<a href="#proxy-を利用したルーティング" class="hash-link" aria-label="Proxy を利用したルーティング への直接リンク" title="Proxy を利用したルーティング への直接リンク">​</a></h2><p><code>leaves</code>に対するアクセスを下記のように処理すると値の配列として取得できる。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ILeaf</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">IBranch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  leaves</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Array</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ILeaf</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> proxy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ProxyHandler</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">IBranch</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">get</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prop </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"leaves"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">leaves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">leaf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> leaf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Object</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hasOwn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">prop </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">keyof</span><span class="token plain"> IBranch</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> branch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> prisma</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">branches</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findFirstOrThrow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> leaves</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Proxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">branch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> proxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>leaves</code>は単純な値の配列となる。</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"leaves"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"hoge"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"huga"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="留意点">留意点<a href="#留意点" class="hash-link" aria-label="留意点 への直接リンク" title="留意点 への直接リンク">​</a></h2><p>プロパティをプライベートにするものではないため、値の更新をする場合には注意が必要。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> records </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"secret"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"keys"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> proxy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">get</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">obj</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prop </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"private"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">prop</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">record</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">prop</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> proxied </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Proxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">records</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> proxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">proxied</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">private</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// &gt; [ { id: 0, value: 'secret' }, { id: 1, value: 'keys' } ]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proxied</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">private</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"hoge"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"huga"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">proxied</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">private</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// &gt; [ undefined, undefined ]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>javascript</category>
            <category>prisma</category>
        </item>
        <item>
            <title><![CDATA[【JavaScript】プリミティブでない値を持つSetにて重複が発生する]]></title>
            <link>https://notes.ogumaru.dev/2022/07/18/duplicated-value-in-set</link>
            <guid>https://notes.ogumaru.dev/2022/07/18/duplicated-value-in-set</guid>
            <pubDate>Mon, 18 Jul 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[概要]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要 への直接リンク" title="概要 への直接リンク">​</a></h2><p>TypeScript にて、タプル風(<code>[T, T]</code>)の配列のコレクションがあり、これの中身をユニークにしたい場面があった。</p><p><code>Set</code>を経由すれば重複排除できると思ったが、見た目上同じオブジェクトの重複は排除されなかった。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="結論">結論<a href="#結論" class="hash-link" aria-label="結論 への直接リンク" title="結論 への直接リンク">​</a></h2><p>JavaScript における配列の同値比較が<code>false</code>になるため。</p><p>厳密にユニークなコレクションを作成する場合は、deepEqual 相当の確認が必要そう。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="実行環境">実行環境<a href="#実行環境" class="hash-link" aria-label="実行環境 への直接リンク" title="実行環境 への直接リンク">​</a></h2><table><thead><tr><th>実行環境</th><th>バージョン</th></tr></thead><tbody><tr><td>node</td><td>v16.15.0</td></tr><tr><td>python3</td><td>Python 3.10.4</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="javascript-の挙動と-python-との比較">JavaScript の挙動と Python との比較<a href="#javascript-の挙動と-python-との比較" class="hash-link" aria-label="JavaScript の挙動と Python との比較 への直接リンク" title="JavaScript の挙動と Python との比較 への直接リンク">​</a></h2><p>タプル風の配列リテラルを<code>add</code>すると、重複した値がそれぞれが追加されてしまう。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> unique </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"hoge"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"huga"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Set(1) { [ 'hoge', 'huga' ] }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"hoge"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"huga"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Set(2) { [ 'hoge', 'huga' ], [ 'hoge', 'huga' ] }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Python ではできた気がしたので確認する。</p><p>(なお<code>["hoge", "huga"]</code>は<code>Hashable</code>でないため<code>set</code>には追加できない)</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">unique </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"hoge"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"huga"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># {('hoge', 'huga')}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"hoge"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"huga"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># {('hoge', 'huga')}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>リテラルのタプルに対して重複排除ができている。</p><p>JavaScript でも、オブジェクトが同一になるため、下記では意図した通りに重複が排除される。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> unique </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> tuple </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"hoge"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"huga"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tuple</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Set(1) { [ 'hoge', 'huga' ] }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tuple</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Set(1) { [ 'hoge', 'huga' ] }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>JavaScript では Python におけるタプル相当のデータ型がないため、上記コードでは実際にはミュータブルな配列となる。</p><p><code>Object.freeze()</code>でイミュータブルにしてみたが、結果は変わらなかった。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> unique </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token known-class-name class-name">Object</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">freeze</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"hoge"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"huga"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Set(1) { [ 'hoge', 'huga' ] }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token known-class-name class-name">Object</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">freeze</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"hoge"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"huga"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Set(2) { [ 'hoge', 'huga' ], [ 'hoge', 'huga' ] }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="仕様の確認">仕様の確認<a href="#仕様の確認" class="hash-link" aria-label="仕様の確認 への直接リンク" title="仕様の確認 への直接リンク">​</a></h2><p>MDN の<code>Set</code>のページを見ると、<code>-0</code>と<code>+0</code>について触れられている。</p><blockquote><p>See "Key equality for -0 and 0" in the browser compatibility table for details.</p></blockquote><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set#value_equality" target="_blank" rel="noopener noreferrer">Set - JavaScript | MDN (developer.mozilla.org)</a></p><p>等価比較のページを見ると、</p><blockquote><p>SameValueZero: used by %TypedArray% and ArrayBuffer constructors, as well as Map and Set operations, and also String.prototype.includes and Array.prototype.includes since ES2016</p></blockquote><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Equality_comparisons_and_sameness" target="_blank" rel="noopener noreferrer">Equality comparisons and sameness - JavaScript | MDN (developer.mozilla.org)</a></p><p><code>SameValueZero</code>の TC39 へリンクされていたのでこちらも確認。</p><blockquote><p>SameValueZero differs from SameValue only in that it treats +0𝔽 and -0𝔽 as equivalent.</p></blockquote><p><a href="https://tc39.es/ecma262/#sec-samevaluezero" target="_blank" rel="noopener noreferrer">SameValueZero | ECMAScript® 2023 Language&nbsp;Specification (tc39.es)</a></p><p><code>SameValue</code>と<code>+0</code>と<code>-0</code>の比較結果のみ異なるとあるため、<a href="https://tc39.es/ecma262/#sec-samevalue" target="_blank" rel="noopener noreferrer"><code>SameValue</code></a>を確認すると、</p><blockquote><ol><li><p>If Type(x) is different from Type(y), return false.</p></li><li><p>If Type(x) is Number, then</p><p>a. Return Number::sameValue(x, y).</p></li><li><p>If Type(x) is BigInt, then</p><p>a. Return BigInt::sameValue(x, y).</p></li><li><p>Return SameValueNonNumeric(x, y).</p></li></ol></blockquote><p>とのことなので<a href="https://tc39.es/ecma262/#sec-samevaluenonnumeric" target="_blank" rel="noopener noreferrer"><code>SameValueNonNumeric</code></a>を確認。</p><blockquote><ol><li><p>Assert: Type(x) is the same as Type(y).</p></li><li><p>If Type(x) is Undefined, return true.</p></li><li><p>If Type(x) is Null, return true.</p></li><li><p>If Type(x) is String, then</p><p>a. If x and y are exactly the same sequence of code units (same length and same code units at corresponding indices), return true; otherwise, return false.</p></li><li><p>If Type(x) is Boolean, then</p><p>a. If x and y are both true or both false, return true; otherwise, return false.</p></li><li><p>If Type(x) is Symbol, then</p><p>a. If x and y are both the same Symbol value, return true; otherwise, return false.</p></li><li><p>If x and y are the same Object value, return true. Otherwise, return false.</p></li></ol></blockquote><p>タプルの場合<code>7</code>にて評価されると思われ、<code>same Object value</code>ではないということになるようだ。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="same-object-value-とは">same Object value とは<a href="#same-object-value-とは" class="hash-link" aria-label="same Object value とは への直接リンク" title="same Object value とは への直接リンク">​</a></h2><p>TC39にはこれ以上のリンクがなかったが、deepEqual相当の比較を行うことで重複の確認はできそう。</p><p>修正 PR いただけるとありがたいです。</p>]]></content:encoded>
            <category>javascript</category>
            <category>python</category>
        </item>
    </channel>
</rss>