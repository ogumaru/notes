<!doctype html>
<html lang="ja" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Notes | Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://notes.ogumaru.dev/"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="google-site-verification" content="FkOa2T2mSsg15ct_wdtvmaCYhu63iM4TvYCCvOfYnL0"><meta data-rh="true" property="og:title" content="Notes | Notes"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="canonical" href="https://notes.ogumaru.dev/"><link data-rh="true" rel="alternate" href="https://notes.ogumaru.dev/" hreflang="ja"><link data-rh="true" rel="alternate" href="https://notes.ogumaru.dev/" hreflang="x-default"><script data-rh="true">function maybeInsertBanner(){window.__DOCUSAURUS_INSERT_BASEURL_BANNER&&insertBanner()}function insertBanner(){var n=document.getElementById("docusaurus-base-url-issue-banner-container");if(n){n.innerHTML='\n<div id="docusaurus-base-url-issue-banner" style="border: thick solid red; background-color: rgb(255, 230, 179); margin: 20px; padding: 20px; font-size: 20px;">\n   <p style="font-weight: bold; font-size: 30px;">Your Docusaurus site did not load properly.</p>\n   <p>A very common reason is a wrong site <a href="https://docusaurus.io/docs/docusaurus.config.js/#baseurl" style="font-weight: bold;">baseUrl configuration</a>.</p>\n   <p>Current configured baseUrl = <span style="font-weight: bold; color: red;">/</span>  (default value)</p>\n   <p>We suggest trying baseUrl = <span id="docusaurus-base-url-issue-banner-suggestion-container" style="font-weight: bold; color: green;"></span></p>\n</div>\n';var e=document.getElementById("docusaurus-base-url-issue-banner-suggestion-container"),s=window.location.pathname,r="/"===s.substr(-1)?s:s+"/";e.innerHTML=r}}window.__DOCUSAURUS_INSERT_BASEURL_BANNER=!0,document.addEventListener("DOMContentLoaded",maybeInsertBanner)</script><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Notes RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Notes Atom Feed"><link rel="stylesheet" href="/assets/css/styles.82d69b66.css">
<link rel="preload" href="/assets/js/runtime~main.c1986dcc.js" as="script">
<link rel="preload" href="/assets/js/main.46051f0f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div id="docusaurus-base-url-issue-banner-container"></div><div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Notes</b></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近のブログ記事のナビゲーション"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/10/20/arcgis-set-dynamically">【JavaScript】ArcGISで動的にMapViewを配置する</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/10/16/dnd-behavior-on-wayland">【JavaScript】Wayland + Chromium環境でファイルのファイルドロップがたまに失敗する</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/10/06/get-started-ubuntu-pro">【Linux】Ubuntu Pro betaを利用してみる</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/10/01/build-wifi-dongle-driver">【Linux】Ubuntu 22.04でWi-FiドングルのドライバをDockerでビルドする</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/09/10/samba-on-raspberrypi-from-ios">【Linux】Raspberry Pi 4のSambaサーバへiPhoneの純正アプリから接続する</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/08/13/proxy-prisma-records">【JavaScript】Prismaの単純なレコードを値の配列として取得する</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/07/18/duplicated-value-in-set">【JavaScript】プリミティブでない値を持つSetにて重複が発生する</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/2022/10/20/arcgis-set-dynamically">【JavaScript】ArcGISで動的にMapViewを配置する</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-10-20T00:00:00.000Z" itemprop="datePublished">2022年10月20日</time> · <!-- -->約4分</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ogumaru" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ogumaru.png" alt="ogumaru"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ogumaru" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">ogumaru</span></a></div><small class="avatar__subtitle" itemprop="description">ogumaru note owner</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a class="hash-link" href="#概要" title="この見出しへのリンク">​</a></h2><p><a href="https://developers.arcgis.com/javascript/latest/" target="_blank" rel="noopener noreferrer">ArcGIS API for JavaScript</a> (<code>@arcgis/core</code>)で <code>MapView</code> を利用する際、インスタンス化時に <code>container</code> プロパティにセレクタの文字列か<code>HTMLElement</code>を指定することで、そこに地図を表示することができる。</p><p>React を利用する都合上、静的な HTML ではなく、表示対象となる要素(React コンポーネント)が描画されたあと、そこに表示されるようにしたい。</p><p>実装は ES Modules および TypeScript を利用して行った。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="結論">結論<a class="hash-link" href="#結論" title="この見出しへのリンク">​</a></h2><p><code>useEffect</code>内で<code>__esri.Accessor.set()</code>から<code>container</code>を指定する。</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> useEffect </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;react&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">MapView</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;@arcgis/core/views/MapView&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ここでは container は指定しない。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// レイヤの操作をする都合上、</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// export する必要があるためsetup内でインスタンス化できない。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> mapView </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MapView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** 略 **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">setup</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 動的に container を指定</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mapView</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;container&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;viewDiv&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">App</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">setup</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">viewDiv</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="環境">環境<a class="hash-link" href="#環境" title="この見出しへのリンク">​</a></h2><table><thead><tr><th>項目</th><th>内容</th></tr></thead><tbody><tr><td>React</td><td>18.2.0</td></tr><tr><td>ArcGIS API for JavaScript</td><td>4.24.7</td></tr><tr><td>TypeScript</td><td>4.8.4</td></tr><tr><td>webpack</td><td>5.74.0</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="動的な配置">動的な配置<a class="hash-link" href="#動的な配置" title="この見出しへのリンク">​</a></h2><p><code>MapView</code>がインスタンス化されたときに<code>container</code>に指定した際、この時点で該当の HTML 要素がない場合は地図が表示されない。</p><p>React を利用している場合、コンポーネントがマウントされたタイミングで描画されるように、<code>useEffect</code>内で<code>MapView</code>をインスタンス化すれば問題なく表示ができる。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="containerプロパティ"><code>container</code>プロパティ<a class="hash-link" href="#containerプロパティ" title="この見出しへのリンク">​</a></h2><p>サンプルコードなどでは下記のようにコンストラクタで<code>container</code>に HTML 要素の<code>id</code>文字列を指定することが多い。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> mapView </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MapView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// (略)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  container</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;viewDiv&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>このとき、<code>container</code>プロパティの型は <code>string | HTMLDivElement</code>となっているため、TypeScript の型エラーは出ない。</p><p>(ヒントには<code>__esri.DOMContainerProperties.container?: string | HTMLDivElement</code>とでるが、該当の型はドキュメントには見つからなかった)</p><p><a href="https://developers.arcgis.com/javascript/latest/api-reference/esri-views-MapView.html#container" target="_blank" rel="noopener noreferrer">MapView | API Reference | ArcGIS API for JavaScript 4.24 | ArcGIS Developers - (developers.arcgis.com)</a></p><p>一方、<code>MapView</code>がインスタンス化された場合、<code>container</code>プロパティは<code>DOMContainer.container</code>を指してしまい、指定できるのは<code>HTMLDivElement</code>のみとなる。</p><p><a href="https://developers.arcgis.com/javascript/latest/api-reference/esri-views-DOMContainer.html#container" target="_blank" rel="noopener noreferrer">DOMContainer | API Reference | ArcGIS API for JavaScript 4.24 | ArcGIS Developers - (developers.arcgis.com)</a></p><p>そのため下記コードでは型エラーが発生してしまう。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> mapView </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MapView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mapView</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">container </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;viewDiv&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>Type &#x27;string&#x27; is not assignable to type &#x27;HTMLDivElement&#x27;.ts(2322)</p></blockquote><p><code>MapView</code>ではなく、これが継承している<code>__esri.Accessor</code>が<code>set</code>メソッドを持っており、これを利用することで動的に<code>container</code>を指定することができた。</p><p><a href="https://developers.arcgis.com/javascript/latest/api-reference/esri-core-Accessor.html#set" target="_blank" rel="noopener noreferrer">Accessor | API Reference | ArcGIS API for JavaScript 4.24 | ArcGIS Developers - (developers.arcgis.com)</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>タグ:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/typescript">typescript</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/javascript">javascript</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/arcgis">arcgis</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/react">react</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/2022/10/16/dnd-behavior-on-wayland">【JavaScript】Wayland + Chromium環境でファイルのファイルドロップがたまに失敗する</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-10-16T00:00:00.000Z" itemprop="datePublished">2022年10月16日</time> · <!-- -->約4分</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ogumaru" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ogumaru.png" alt="ogumaru"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ogumaru" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">ogumaru</span></a></div><small class="avatar__subtitle" itemprop="description">ogumaru note owner</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a class="hash-link" href="#概要" title="この見出しへのリンク">​</a></h2><p>ウェブブラウザの File API を利用して、ファイルのドラッグ &amp; ドロップを利用した機能を実装している際、ファイルの検証を行っているにもかかわらず、エラーが発生した。</p><p>必ず失敗するわけではなく、たまに成功するため、動作の確認を行った。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="原因">原因<a class="hash-link" href="#原因" title="この見出しへのリンク">​</a></h2><p>ファイルドロップ時にその中身が変わるのは、Wayland 環境における現状の挙動らしかった。</p><p>参照:</p><ul><li><a href="https://askubuntu.com/questions/1411629/cannot-drag-and-drop-from-nautilus-to-chrome-or-slack" target="_blank" rel="noopener noreferrer">Cannot drag and drop from nautilus to Chrome or Slack - Ask Ubuntu (askubuntu.com)</a></li><li><a href="https://bugs.launchpad.net/ubuntu/+source/nautilus/+bug/1970921" target="_blank" rel="noopener noreferrer">Bug #1970921 “Drag and drop does not work” : Bugs : nautilus package : Ubuntu (bugs.launchpad.net)</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="挙動の確認">挙動の確認<a class="hash-link" href="#挙動の確認" title="この見出しへのリンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="環境">環境<a class="hash-link" href="#環境" title="この見出しへのリンク">​</a></h3><table><thead><tr><th>環境</th><th>バージョン</th></tr></thead><tbody><tr><td>OS</td><td>Ubuntu 22.04.1 LTS</td></tr><tr><td>Chromiun</td><td>Chromium 106.0.5249.119 snap</td></tr><tr><td>Firefox</td><td>Mozilla Firefox 105.0.3</td></tr><tr><td>Files</td><td>GNOME nautilus 42.2</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="挙動の詳細と確認">挙動の詳細と確認<a class="hash-link" href="#挙動の詳細と確認" title="この見出しへのリンク">​</a></h3><p>デバッガを利用して確認を行った。</p><p>下記のようなコードにおいて、<code>csv.getAsFile()</code>が<code>null</code>になるために例外が発生していた。</p><p>体感として失敗する割合のほうが多いように感じる。</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>再現コード</summary><div><div class="collapsibleContent_i85q"><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// CSV形式かどうかの確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">isCSVItem</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> isCSV </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;text/plain&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;text/csv&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;application/vnd.ms-excel&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;application/octet-stream&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> isCSV</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;dragover&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">stopPropagation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">preventDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dataTransfer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dataTransfer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dropEffect</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;copy&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;drop&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">stopPropagation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">preventDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dataTransfer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// item の確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 同じ操作でも異なる結果になる</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> item </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dataTransfer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">items</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token known-class-name class-name">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword module" style="color:#00009f">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dataTransfer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">items</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">isCSVItem</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ここで返り値が null になる</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">csv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> csv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getAsFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Failed to load csv file.&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> reader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">FileReader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// file が たまに null になるため例外が発生する</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      reader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">readAsDataURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      reader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;load&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ファイルに対する処理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>成功する場合と失敗する場合を比較すると、上記コードの<code>event.dataTransfer.items</code>の要素(<code>DataTransferItem</code>)の中身に違いがあり、下記 2 通りになっていることがわかった。</p><table><thead><tr><th>処理</th><th>kind</th><th>type</th></tr></thead><tbody><tr><td>成功</td><td>file</td><td>text/csv</td></tr><tr><td>失敗</td><td>string</td><td>text/plain</td></tr></tbody></table><p>Firefox ではこの問題は発生せず、<code>kind: file</code>なものが取得できるため問題なく動作した。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="対策">対策<a class="hash-link" href="#対策" title="この見出しへのリンク">​</a></h2><ol><li>ドロップされたデータの<code>kind</code>が<code>file</code>かどうか判定する</li><li><code>input</code>要素からファイルを選択して取得する<br><code>input[type=&quot;file&quot;]</code>ではこの問題は発生しない</li><li>ログイン時に <!-- -->[Ubuntu on Xorg]<!-- --> を利用する</li></ol><p>今回は 1, 2 の対策を行って実装を行った。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>タグ:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/javascript">javascript</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/linux">linux</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/2022/10/06/get-started-ubuntu-pro">【Linux】Ubuntu Pro betaを利用してみる</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-10-06T00:00:00.000Z" itemprop="datePublished">2022年10月6日</time> · <!-- -->約7分</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ogumaru" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ogumaru.png" alt="ogumaru"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ogumaru" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">ogumaru</span></a></div><small class="avatar__subtitle" itemprop="description">ogumaru note owner</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a class="hash-link" href="#概要" title="この見出しへのリンク">​</a></h2><p>また beta がついているが、Ubuntu Pro が<a href="https://ubuntu.com/blog/ubuntu-pro-beta-release" target="_blank" rel="noopener noreferrer">個人でも 5 台まで無償利用できるようになった</a>ため、早速利用してみる。</p><p>全体の流れとしては以下のようになる。</p><ol><li><a href="https://login.ubuntu.com/" target="_blank" rel="noopener noreferrer">Ubuntu One</a>のアカウントの作成</li><li><a href="https://ubuntu.com/pro" target="_blank" rel="noopener noreferrer">Ubuntu Pro</a>へログイン</li><li>トークンの取得</li><li><code>pro</code>コマンドを利用できるようにする</li><li>端末をアタッチ</li></ol><p><a href="https://discourse.ubuntu.com/t/ubuntu-pro-beta-tutorial/31018" target="_blank" rel="noopener noreferrer">Ubuntu Pro beta tutorial</a>を参考に進めれば特に詰まるところもない。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="環境">環境<a class="hash-link" href="#環境" title="この見出しへのリンク">​</a></h2><table><thead><tr><th>項目</th><th>内容</th></tr></thead><tbody><tr><td>OS</td><td>Ubuntu 22.04.1 LTS</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="利用手順">利用手順<a class="hash-link" href="#利用手順" title="この見出しへのリンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ubuntu-one-アカウントの作成--ubuntu-pro-へログイン">Ubuntu One アカウントの作成 / Ubuntu Pro へログイン<a class="hash-link" href="#ubuntu-one-アカウントの作成--ubuntu-pro-へログイン" title="この見出しへのリンク">​</a></h3><p>Ubuntu One のアカウントを作成したあと、Ubuntu Pro のページから再度ログインを行うと下図の画面になる。</p><p><img loading="lazy" alt="Personal Data Request" src="/assets/images/Personal_Data_Request-1a4c031b0b874332c27f62286e682902.png" title="Personal Data Request" width="1187" height="661" class="img_ev3q"></p><p>なお、「Service authorization for Ubuntu.com」はチェックを入れないと進めなかった。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="トークンの取得">トークンの取得<a class="hash-link" href="#トークンの取得" title="この見出しへのリンク">​</a></h3><p>Ubuntu Pro にログイン後、下記の画面から「UA subscriptions」を押下するとトークンが確認できる。</p><p><img loading="lazy" alt="UA Subscriptions" src="/assets/images/UA_subscriptions-27b86d151171f80f126acdcc09c06d75.png" title="UA Subscriptions" width="1402" height="822" class="img_ev3q"></p><p><code>Token</code>とある箇所にトークン、その下にはアタッチの際のコマンドが書いてある。</p><p><img loading="lazy" alt="Your subscriptions" src="/assets/images/Your_subscriptions-8b38a57ccc79d2f37d40dfd5ece127c1.png" title="Your subscriptions" width="1394" height="878" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="proコマンドを利用できるようにする"><code>pro</code>コマンドを利用できるようにする<a class="hash-link" href="#proコマンドを利用できるようにする" title="この見出しへのリンク">​</a></h3><p>詳細は後述するが、<code>pro</code>コマンドのために追加でインストールが必要にはならなかった。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> upgrade</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="端末のアタッチ">端末のアタッチ<a class="hash-link" href="#端末のアタッチ" title="この見出しへのリンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> pro attach </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${表示されているTOKEN}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Enabling default service esm-infra</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Updating package lists</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Ubuntu Pro: ESM Infra enabled</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Enabling default service livepatch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Installing canonical-livepatch snap</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Canonical livepatch enabled.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Unable to determine current instance-id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; This machine is now attached to &#x27;Ubuntu Pro - free personal subscription&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; SERVICE          ENTITLED  STATUS    DESCRIPTION</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; esm-infra        yes       enabled   Expanded Security # &gt; Maintenance for Infrastructure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; livepatch        yes       enabled   Canonical Livepatch service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; NOTICES</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Operation in progress: pro attach</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Enable services with: pro enable &lt;service&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;      Account: ogumaru@example.com</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Subscription: Ubuntu Pro - free personal subscription</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>実行もほとんど時間はかからず、特に再起動を求められることはなかった。</p><p>上記コマンドでアタッチ後にはトップバーに下図の常駐アイコンが表示されるようになる。</p><p><img loading="lazy" alt="Livepatchのアイコン" src="/assets/images/Livepatch-afe6d8acd5af2c9737a3e48f534388e7.png" title="Livepatchのアイコン" width="286" height="164" class="img_ev3q"></p><p>「Livepatch Settings」を押下するとライブパッチの設定のほか、トップバーの常駐アイコン表示切り替えや端末のデタッチもできる。</p><p><img loading="lazy" alt="Detach this machine" src="/assets/images/Detach_this_machine-1385d7dc8f1f9f0ce8b5c5c80c6269ec.png" title="Detach this machine" width="998" height="523" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="トークンについて">トークンについて<a class="hash-link" href="#トークンについて" title="この見出しへのリンク">​</a></h2><p><code>Token</code>は端末認証後も変わらず(=5 台とも同じトークンを利用するはず)、またトークンの更新画面も見つからなかった。</p><p>トークンが漏れてしまった場合の対策は気になる。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="proコマンドの実体について"><code>pro</code>コマンドの実体について<a class="hash-link" href="#proコマンドの実体について" title="この見出しへのリンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="結論">結論<a class="hash-link" href="#結論" title="この見出しへのリンク">​</a></h3><p><code>ubuntu-advantage</code>が実体となっている。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="proコマンドの有無"><code>pro</code>コマンドの有無<a class="hash-link" href="#proコマンドの有無" title="この見出しへのリンク">​</a></h3><p>これまでの環境では<code>pro</code>コマンドは利用できなかった。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># pro コマンドは利用できない</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">command</span><span class="token plain"> -v pro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 実行してもパッケージの候補にはでてこない</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Command &#x27;pro&#x27; not found, did you mean:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   command &#x27;gpro&#x27; from snap gpro (1.0.24)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   command &#x27;ro&#x27; from deb golang-redoctober (0.0~git20161017.0.78e9720-5)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   command &#x27;proj&#x27; from deb proj-bin (8.2.1-1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   command &#x27;prt&#x27; from deb prt (0.22-1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   command &#x27;pio&#x27; from deb platformio (4.3.4-2)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   command &#x27;pr&#x27; from deb coreutils (8.32-4.1ubuntu1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   command &#x27;pry&#x27; from deb pry (0.13.1-2)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; See &#x27;snap info &lt;snapname&gt;&#x27; for additional versions.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>apt upgrade</code>でパッケージ更新をしたあと利用できるようになる。</p><p>パッケージとしては<code>ubuntu-advantage-tools</code>の一部なようで、これがアップデートされることで<code>pro</code>が利用できるようになるようだ。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> upgrade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; The following packages will be upgraded:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   ubuntu-advantage-tools</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; 1 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Need to get 163 kB of archives.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; After this operation, 113 kB of additional disk space will be # used.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Do you want to continue? [Y/n] y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Get:1 http://jp.archive.ubuntu.com/ubuntu jammy-updates/main # amd64 ubuntu-advantage-tools amd64 27.11.2~22.04.1 [163 kB]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Fetched 163 kB in 0s (723 kB/s)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Preconfiguring packages ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; (Reading database ... 183922 files and directories currently installed.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Preparing to unpack .../ubuntu-advantage-tools_27.11.2~22.04.1_amd64.deb ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Unpacking ubuntu-advantage-tools (27.11.2~22.04.1) over (27.10.1~22.04.1) ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Setting up ubuntu-advantage-tools (27.11.2~22.04.1) ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Installing new version of config file /etc/ubuntu-advantage/help_data.yaml ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Installing new version of config file /etc/ubuntu-advantage/uaclient.conf ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Processing triggers for man-db (2.10.2-1) ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="実体の確認と関連コマンド">実体の確認と関連コマンド<a class="hash-link" href="#実体の確認と関連コマンド" title="この見出しへのリンク">​</a></h3><p><code>pro</code>コマンドの実体を確認すると<code>ubuntu-advantage</code>へのシンボリックリンクになっていた。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">command</span><span class="token plain"> -v pro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; /usr/bin/pro</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable builtin class-name" style="color:#36acaa">command</span><span class="token string variable" style="color:#36acaa"> -v pro</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; /usr/bin/pro: symbolic link to ubuntu-advantage</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>また、<a href="https://ubuntu.com/security/certifications/docs/fips-enablement" target="_blank" rel="noopener noreferrer">ここ</a>に記載されているような<code>ua</code>コマンドも、同様に<code>ubuntu-advantage</code>へのシンボリックリンクとなっていた。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable builtin class-name" style="color:#36acaa">command</span><span class="token string variable" style="color:#36acaa"> -v ua </span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/bin/ua: symbolic </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"> to ubuntu-advantage</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://discourse.ubuntu.com/t/ubuntu-pro-client/31027" target="_blank" rel="noopener noreferrer">Ubuntu Pro Client</a>にも下記の記載がある。</p><blockquote><p>Note: The Ubuntu Advantage client or UA client has been renamed to the Ubuntu Pro client in line with the rebranding of Ubuntu Advantage to Ubuntu Pro 4. Specific commands have also been updated to refer to Ubuntu Pro rather than Ubuntu Advantage.</p></blockquote><p><code>ubuntu-advantage</code>自体を呼び出しても、ヘルプ内は<code>pro</code>となっていた。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu-advantage --help</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; usage: pro &lt;command&gt; [flags]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://github.com/canonical/ubuntu-advantage-client/commit/a92c75598787e33b1c15dee8d05289c49357670f" target="_blank" rel="noopener noreferrer">ドキュメントの修正コミット(docs: ua -&gt; pro)</a>でも見られるように、ドキュメントも<code>pro</code>へ更新されている。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>タグ:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ubuntu">ubuntu</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/linux">linux</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/2022/10/01/build-wifi-dongle-driver">【Linux】Ubuntu 22.04でWi-FiドングルのドライバをDockerでビルドする</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-10-01T00:00:00.000Z" itemprop="datePublished">2022年10月1日</time> · <!-- -->約6分</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ogumaru" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ogumaru.png" alt="ogumaru"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ogumaru" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">ogumaru</span></a></div><small class="avatar__subtitle" itemprop="description">ogumaru note owner</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a class="hash-link" href="#概要" title="この見出しへのリンク">​</a></h2><p>これまで Wi-Fi 接続用の USB ドングルを利用する際にドライバのビルドが必要になることがあったため、作業の記録も兼ねてまとめておく。</p><p>依存パッケージが多いため、Docker を利用してビルドを行うこととする。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="環境利用機器">環境・利用機器<a class="hash-link" href="#環境利用機器" title="この見出しへのリンク">​</a></h2><table><thead><tr><th>環境</th><th>バージョン</th></tr></thead><tbody><tr><td>OS</td><td>Ubuntu 22.04.1 LTS</td></tr><tr><td>Docker</td><td>20.10.14, build a224086</td></tr></tbody></table><table><thead><tr><th>製品</th><th>コントローラ</th></tr></thead><tbody><tr><td><a href="https://www.amazon.co.jp/gp/product/B01N44FMI9/" target="_blank" rel="noopener noreferrer">アイ・オー・データ社 WNPU583B</a></td><td><a href="https://www.realtek.com/ja/products/communications-network-ics/item/rtl8821ce" target="_blank" rel="noopener noreferrer">rtl8821ce</a></td></tr><tr><td><a href="https://www.amazon.co.jp/gp/product/B00C58G612/" target="_blank" rel="noopener noreferrer">アイ・オー・データ社 WN-AC867U</a></td><td><a href="https://www.realtek.com/ja/products/communications-network-ics/item/rtl8812au" target="_blank" rel="noopener noreferrer">rtl8812au</a></td></tr></tbody></table><p>WNPU583B は Wi-Fi/Bluetooth 両方使用できることを確認する。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ドライバのビルドインストール">ドライバのビルド・インストール<a class="hash-link" href="#ドライバのビルドインストール" title="この見出しへのリンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="docker-コンテナの起動-ホスト側">Docker コンテナの起動 (ホスト側)<a class="hash-link" href="#docker-コンテナの起動-ホスト側" title="この見出しへのリンク">​</a></h3><p>rtl8812au のドライバが多く迷うが、<a href="https://github.com/search?q=rtl8812au" target="_blank" rel="noopener noreferrer">GitHub での「rtl8812au」の検索結果</a>の上位のものを利用した。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/gnab/rtl8812au.git driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run --rm -it -v </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable builtin class-name" style="color:#36acaa">pwd</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">/driver:/data&quot;</span><span class="token plain"> -w </span><span class="token string" style="color:#e3116c">&quot;/data&quot;</span><span class="token plain"> ubuntu:jammy /bin/bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>後述するカーネルヘッダのパッケージをインストールするためには、ホストとコンテナの OS(ディストリビューション)を合わせる必要がある。</p><p>最初<code>gcc</code>のコンテナでビルドしようとしたが、ベースとなる OS が異なるためこのパッケージがなかった。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="依存パッケージのインストール-コンテナ側">依存パッケージのインストール (コンテナ側)<a class="hash-link" href="#依存パッケージのインストール-コンテナ側" title="この見出しへのリンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> build-essential </span><span class="token string" style="color:#e3116c">&quot;linux-headers-</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">uname</span><span class="token string variable" style="color:#36acaa"> -r</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>なお、<code>linux-headers-*</code>のパッケージをインストールしないと下記のエラーが出る。</p><blockquote><p>make<!-- -->[1]<!-- -->: <!-- -->*<!-- -->*<!-- -->*<!-- --> /lib/modules/5.15.0-47-generic/build: No such file or directory.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ドライバのビルド-コンテナ側">ドライバのビルド (コンテナ側)<a class="hash-link" href="#ドライバのビルド-コンテナ側" title="この見出しへのリンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">make</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ドライバのテスト-ホスト側">ドライバのテスト (ホスト側)<a class="hash-link" href="#ドライバのテスト-ホスト側" title="この見出しへのリンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> insmod driver/8812au.ko</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>この状態では再起動の際にモジュールへの参照が解除されてしまう。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="インストール-ホスト側">インストール (ホスト側)<a class="hash-link" href="#インストール-ホスト側" title="この見出しへのリンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> 8812au.ko </span><span class="token string" style="color:#e3116c">&quot;/lib/modules/</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">uname</span><span class="token string variable" style="color:#36acaa"> -r</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">/kernel/drivers/net/wireless&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> depmod</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上記のほか、カーネルアップデートをした際に自動でビルドするには DKMS を利用する必要がある。</p><p>詳細は<a href="https://github.com/gnab/rtl8812au/" target="_blank" rel="noopener noreferrer">リポジトリの README</a>に書いてある。</p><p><code>build-essential</code>や<code>dkms</code>などのパッケージを入れる必要があるため、今回は対応しないこととする。</p><p>(別の機会に Docker を利用した方法を試したい。)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ソースコードの確認">ソースコードの確認<a class="hash-link" href="#ソースコードの確認" title="この見出しへのリンク">​</a></h2><p>ここまででドングルは動作する状態にはなったが、製品への対応状況を確認するため、今回利用したリポジトリと APT リポジトリのソースコードを比較しつつ確認してみる。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ベンダー-idプロダクト-id-の確認">ベンダー ID・プロダクト ID の確認<a class="hash-link" href="#ベンダー-idプロダクト-id-の確認" title="この見出しへのリンク">​</a></h3><p>ソースコードを探るにあたり、製品の ID を確認する。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">lsusb </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> -i wn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Bus 001 Device 013: ID 0bda:0823 Realtek Semiconductor Corp. WNPU583B</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Bus 001 Device 012: ID 04bb:0952 I-O Data Device, Inc. WN-AC867U</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>0bda:0823</code>や<code>04bb:0952</code>がベンダー ID(<code>idVendor</code>)とプロダクト ID(<code>idProduct</code>)の値のため、これを利用してソースコードを検索する。
ベンダー ID を含めるとヒット件数が多いため、プロダクト ID を利用して検索を行う。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="今回利用したリポジトリのソースコード">今回利用したリポジトリのソースコード<a class="hash-link" href="#今回利用したリポジトリのソースコード" title="この見出しへのリンク">​</a></h3><p><a href="https://github.com/gnab/rtl8812au.git" target="_blank" rel="noopener noreferrer">https://github.com/gnab/rtl8812au.git</a>のソースコード内から関連する記述を確認する。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> -iP </span><span class="token string" style="color:#e3116c">&#x27;0x(0823|0952)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; os_dep/linux/usb_intf.c:        {USB_DEVICE(0x04BB, 0x0952),.driver_info = RTL8812}, /* I-O DATA - Edimax */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; os_dep/linux/usb_intf.c:        {USB_DEVICE(0x0bda, 0x0823),.driver_info = RTL8821}, /* I-O DATA - WNPU583B */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="apt-リポジトリのソースコード">APT リポジトリのソースコード<a class="hash-link" href="#apt-リポジトリのソースコード" title="この見出しへのリンク">​</a></h3><p>ホスト環境の設定を変えたくなかったのでコンテナ環境でソースコードを取得する</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 何かしらエディタをインストール</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># deb-src のコメントアウトを解除する</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">busybox </span><span class="token function" style="color:#d73a49">vi</span><span class="token plain"> /etc/apt/sources.list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 関連するパッケージを検索</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> search --names-only </span><span class="token string" style="color:#e3116c">&#x27;rtl88[21]{2}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Sorting... Done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Full Text Search... Done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8812au-dkms/jammy,jammy 4.3.8.12175.20140902+dfsg-0ubuntu15 all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   dkms source for the r8812au network driver</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8821ce-dkms/jammy,jammy 5.5.2.1-0ubuntu10 all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;   DKMS source for the Realtek 8821C PCIe Wi-Fi driver</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上記のパッケージ検索結果から<code>rtl8812au-dkms</code>と<code>rtl8821ce-dkms</code>を確認することにする。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ソースコードのダウンロード</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token builtin class-name">source</span><span class="token plain"> rtl8812au-dkms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下記のメッセージが出てきたが、今回は<code>apt source</code>でダウンロードしたものを確認する。</p><blockquote><p>Picking &#x27;rtl8812au&#x27; as source package instead of &#x27;rtl8812au-dkms&#x27;<br>
<!-- -->NOTICE: &#x27;rtl8812au&#x27; packaging is maintained in the &#x27;Git&#x27; version control system at:<br>
<a href="https://github.com/rsalveti/rtl8812au.git" target="_blank" rel="noopener noreferrer">https://github.com/rsalveti/rtl8812au.git</a><br>
<!-- -->Please use:<br>
<!-- -->git clone <a href="https://github.com/rsalveti/rtl8812au.git" target="_blank" rel="noopener noreferrer">https://github.com/rsalveti/rtl8812au.git</a><br>
<!-- -->to retrieve the latest (possibly unreleased) updates to the package.</p></blockquote><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token builtin class-name">source</span><span class="token plain"> rtl8821ce-dkms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下記のメッセージが出てきたが、こちらも<code>apt source</code>でダウンロードしたものを確認する。</p><blockquote><p>Picking &#x27;rtl8821ce&#x27; as source package instead of &#x27;rtl8821ce-dkms&#x27;<br>
<!-- -->NOTICE: &#x27;rtl8821ce&#x27; packaging is maintained in the &#x27;Git&#x27; version control system at:<br>
<a href="https://git.launchpad.net/~canonical-hwe-team/ubuntu/+source/rtl8821ce-dkms/+git/rtl8821ce-dkms" target="_blank" rel="noopener noreferrer">https://git.launchpad.net/~canonical-hwe-team/ubuntu/+source/rtl8821ce-dkms/+git/rtl8821ce-dkms</a><br>
<!-- -->Please use:<br>
<!-- -->git clone <a href="https://git.launchpad.net/~canonical-hwe-team/ubuntu/+source/rtl8821ce-dkms/+git/rtl8821ce-dkms" target="_blank" rel="noopener noreferrer">https://git.launchpad.net/~canonical-hwe-team/ubuntu/+source/rtl8821ce-dkms/+git/rtl8821ce-dkms</a><br>
<!-- -->to retrieve the latest (possibly unreleased) updates to the package.</p></blockquote><p>ダウンロードしたソースコードから関連する記述を検索する。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ダウンロードされたファイルの確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8812au-4.3.8.12175.20140902+dfsg</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8812au_4.3.8.12175.20140902+dfsg-0ubuntu15.debian.tar.xz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8812au_4.3.8.12175.20140902+dfsg-0ubuntu15.dsc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8812au_4.3.8.12175.20140902+dfsg.orig.tar.gz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8821ce-5.5.2.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8821ce_5.5.2.1-0ubuntu10.debian.tar.xz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8821ce_5.5.2.1-0ubuntu10.dsc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; rtl8821ce_5.5.2.1.orig.tar.gz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 関連する記述を確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> -name </span><span class="token string" style="color:#e3116c">&quot;*.c&quot;</span><span class="token plain"> -print0 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xargs</span><span class="token plain"> -0 </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> -iP </span><span class="token string" style="color:#e3116c">&#x27;0x(0823|0952)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; ./rtl8812au-4.3.8.12175.20140902+dfsg/.pc/0009-usb_intf-extending-compatible-vendor-list.patch/os_dep/linux/usb_intf.c: {USB_DEVICE(0x04BB, 0x0952),.driver_info = RTL8812}, /* I-O DATA - Edimax */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; ./rtl8812au-4.3.8.12175.20140902+dfsg/.pc/0004-Adding-additional-compatible-devices.patch/os_dep/linux/usb_intf.c:  {USB_DEVICE(0x04BB, 0x0952),.driver_info = RTL8812}, /* I-O DATA - Edimax */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; ./rtl8812au-4.3.8.12175.20140902+dfsg/os_dep/linux/usb_intf.c:  {USB_DEVICE(0x04BB, 0x0952),.driver_info = RTL8812}, /* I-O DATA - Edimax *</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>依存パッケージが多く入れたくないため確認していないが、上記からの予想として、WN-AC867U であれば<code>rtl8812au</code>のパッケージをインストールすれば利用できる可能性がある。</p><p>WNPU583B に関連する部分はヒットしないため動作するか不明。</p><p>(過去の経験では Kubuntu 20.04 において <code>rtl8821ce-dkms</code>をインストールすることで Bluetooth だけは利用できた。)</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>タグ:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ubuntu">ubuntu</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/linux">linux</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/wifi">wifi</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/2022/09/10/samba-on-raspberrypi-from-ios">【Linux】Raspberry Pi 4のSambaサーバへiPhoneの純正アプリから接続する</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-09-10T00:00:00.000Z" itemprop="datePublished">2022年9月10日</time> · <!-- -->約5分</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ogumaru" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ogumaru.png" alt="ogumaru"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ogumaru" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">ogumaru</span></a></div><small class="avatar__subtitle" itemprop="description">ogumaru note owner</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a class="hash-link" href="#概要" title="この見出しへのリンク">​</a></h2><p>Raspberry Pi 4 を利用して LAN 内に Samba サーバを構築し、iPhone に標準でインストールされている「ファイル」アプリからの接続を行う</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="環境">環境<a class="hash-link" href="#環境" title="この見出しへのリンク">​</a></h2><table><thead><tr><th>項目</th><th>内容</th></tr></thead><tbody><tr><td>クライアント機種</td><td>iPhone 8 Plus</td></tr><tr><td>クライアント OS</td><td>iOS 15.6.1</td></tr><tr><td>サーバ機種</td><td>Raspberry Pi 4 Model B</td></tr></tbody></table><p>Raspberry Pi OS はバージョンがないらしいため下記で確認</p><p>(ベータ版で出た 64-bit の OS を入れた記憶がある)</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">uname</span><span class="token plain"> -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Linux raspberrypi 5.10.103-v8+ #1529 SMP PREEMPT Tue Mar 8 12:26:46 GMT 2022 aarch64 GNU/Linux</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lsb_release -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; No LSB modules are available.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Distributor ID: Debian</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Description:    Debian GNU/Linux 10 (buster)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Release:    10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Codename:   buster</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">samba --version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt; Version 4.9.5-Debian</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="準備">準備<a class="hash-link" href="#準備" title="この見出しへのリンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="samba-パッケージ">Samba パッケージ<a class="hash-link" href="#samba-パッケージ" title="この見出しへのリンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> samba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># iOS や macOSでも利用する場合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> samba-vfs-modules</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ユーザ">ユーザ<a class="hash-link" href="#ユーザ" title="この見出しへのリンク">​</a></h3><p>ここは<a href="https://wiki.archlinux.jp/index.php/Samba" target="_blank" rel="noopener noreferrer">Samba - ArchWiki (wiki.archlinux.jp)</a>を参考に設定した</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Sambaユーザの追加</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> pdbedit -a </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">whoami</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># `usershare path` で指定する`/var/lib/samba/usershares` にアクセスするため</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># (所有者:グループ が root:sambashare になっている)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> gpasswd sambashare -a </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">whoami</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>グループ設定を反映させるため再ログインする</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ファイアウォール">ファイアウォール<a class="hash-link" href="#ファイアウォール" title="この見出しへのリンク">​</a></h3><p><a href="https://www.samba.org/~tpot/articles/firewall.html" target="_blank" rel="noopener noreferrer">Firewalling Samba (www.samba.org)</a>によると、許可するのは下記</p><table><thead><tr><th>プロトコル</th><th>ポート</th></tr></thead><tbody><tr><td>UDP</td><td>137</td></tr><tr><td>UDP</td><td>138</td></tr><tr><td>TCP</td><td>139</td></tr><tr><td>TCP</td><td>445</td></tr></tbody></table><p><code>ufw</code>を利用していれば下記</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Samba のルールがあれば利用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> ufw app list </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> -i samba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> ufw allow samba</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="samba-の設定">Samba の設定<a class="hash-link" href="#samba-の設定" title="この見出しへのリンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="グローバル設定ファイル">グローバル設定ファイル<a class="hash-link" href="#グローバル設定ファイル" title="この見出しへのリンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 設定ファイルのバックアップ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> -a /etc/samba/smb.conf</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">,.</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">date</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;+%Y-%m-%d_%H%M%S&#x27;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain">.bak</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 下記差分を追記</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudoedit /etc/samba/smb.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[global]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   usershare path = /var/lib/samba/usershares</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   # For supporting iOS / macOS</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   vfs objects = fruit streams_xattr</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   fruit:metadata = stream</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   fruit:model = MacSamba</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   fruit:posix_rename = yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   fruit:veto_appledouble = no</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   fruit:nfs_aces = no</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   fruit:wipe_intentionally_left_blank_rfork = yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">   fruit:delete_empty_adfiles = yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上記の<code>vfs</code>や<code>fruit</code>の設定がないと、保存の際に「操作を完了できませんでした」「属性が見つかりません」のようなエラーメッセージが表示される</p><p>VFS 関連の設定内容については下記ページのものを利用した</p><p><a href="https://wiki.samba.org/index.php/Configure_Samba_to_Work_Better_with_Mac_OS_X" target="_blank" rel="noopener noreferrer">Configure Samba to Work Better with Mac OS X - SambaWiki (wiki.samba.org)</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="共有設定ファイル">共有設定ファイル<a class="hash-link" href="#共有設定ファイル" title="この見出しへのリンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 共有するディレクトリの作成</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p ~/share</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 共有設定ファイルの作成</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net usershare </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;share&quot;</span><span class="token plain"> ~/share/ </span><span class="token string" style="color:#e3116c">&quot;samba share&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">whoami</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">:f&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>権限の設定については
<a href="https://www.samba.org/samba/docs/current/man-html/net.8.html" target="_blank" rel="noopener noreferrer">net (www.samba.org)</a>などを参考に指定する</p><blockquote><p>The definition of a user defined share acl is: &quot;user:permission&quot;, where user is a valid username on the system and permission can be &quot;F&quot;, &quot;R&quot;, or &quot;D&quot;. &quot;F&quot; stands for &quot;full permissions&quot;, ie. read and write permissions. &quot;D&quot; stands for &quot;deny&quot; for a user, ie. prevent this user from accessing this share. &quot;R&quot; stands for &quot;read only&quot;, ie. only allow read access to this share (no creation of new files or directories or writing to files).</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="設定の反映">設定の反映<a class="hash-link" href="#設定の反映" title="この見出しへのリンク">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl reload smbd.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="接続">接続<a class="hash-link" href="#接続" title="この見出しへのリンク">​</a></h2><p>mDNS で名前解決ができれば、同じネットワークにつないだ上で iOS の「ファイル」から</p><ol><li>[ブラウズ]</li><li>右上の丸で囲まれた三点(…)</li><li>[サーバへ接続]</li><li><code>raspberrypi.local</code>など</li><li>[登録ユーザ]<!-- --> を選択</li><li>Raspberry Pi のユーザ情報を入力</li></ol><p>で接続できる</p><p>例えば写真は共有から「&quot;ファイル&quot;に保存」から上記フォルダを選択することで保存できる</p><p>当初 VFS 関連(<code>vfs</code>や<code>fruit</code>)を設定しておらず、ここで保存ができずに困ってかなり時間を使った</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="パフォーマンスについて">パフォーマンスについて<a class="hash-link" href="#パフォーマンスについて" title="この見出しへのリンク">​</a></h2><p>1MB の画像をコピーするのに 体感で 1 秒程度</p><p>10MB の動画をコピーするのに 体感で 2 〜 3 秒程度</p><p>SSD を接続した USB ブートで利用しているため、Raspberry Pi 環境の中では比較的 I/O は早いはず</p><p>microSD 環境ではもう少し遅いかもしれない</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>タグ:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ubuntu">ubuntu</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/linux">linux</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/raspberrypi">raspberrypi</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/samba">samba</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ios">ios</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/2022/08/13/proxy-prisma-records">【JavaScript】Prismaの単純なレコードを値の配列として取得する</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-08-13T00:00:00.000Z" itemprop="datePublished">2022年8月13日</time> · <!-- -->約3分</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ogumaru" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ogumaru.png" alt="ogumaru"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ogumaru" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">ogumaru</span></a></div><small class="avatar__subtitle" itemprop="description">ogumaru note owner</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a class="hash-link" href="#概要" title="この見出しへのリンク">​</a></h2><p>Prisma を利用して、 1:N のリレーションを持つ単純なレコードの値を配列として取得する。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="結論">結論<a class="hash-link" href="#結論" title="この見出しへのリンク">​</a></h2><p><code>Proxy</code>を利用する。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="実行環境">実行環境<a class="hash-link" href="#実行環境" title="この見出しへのリンク">​</a></h2><table><thead><tr><th>実行環境</th><th>バージョン</th></tr></thead><tbody><tr><td>node</td><td>v16.15.0</td></tr><tr><td>prisma</td><td>4.2.1</td></tr><tr><td>@prisma/client</td><td>4.2.1</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="やりたいこと">やりたいこと<a class="hash-link" href="#やりたいこと" title="この見出しへのリンク">​</a></h2><p><img loading="lazy" alt="LeavesとBranchesのER図" src="data:image/svg+xml;base64,PHN2ZyBhcmlhLWxhYmVsbGVkYnk9ImNoYXJ0LXRpdGxlLWdyYXBoLWRpdiBjaGFydC1kZXNjLWdyYXBoLWRpdiIgcm9sZT0iaW1nIiB2aWV3Qm94PSIwIDAgMTQwIDI1MSIgc3R5bGU9Im1heC13aWR0aDogMTQwcHg7IiBoZWlnaHQ9IjI1MSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTAwJSIgaWQ9ImdyYXBoLWRpdiIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxzdHlsZT5AaW1wb3J0IHVybCgiaHR0cHM6Ly9jZG5qcy5jbG91ZGZsYXJlLmNvbS9hamF4L2xpYnMvZm9udC1hd2Vzb21lLzUuMTUuMi9jc3MvYWxsLm1pbi5jc3MiKTsnPC9zdHlsZT48dGl0bGUgaWQ9ImNoYXJ0LXRpdGxlLWdyYXBoLWRpdiI+PC90aXRsZT48ZGVzYyBpZD0iY2hhcnQtZGVzYy1ncmFwaC1kaXYiPjwvZGVzYz48c3R5bGU+I2dyYXBoLWRpdiB7Zm9udC1mYW1pbHk6InRyZWJ1Y2hldCBtcyIsdmVyZGFuYSxhcmlhbCxzYW5zLXNlcmlmO2ZvbnQtc2l6ZToxNnB4O2ZpbGw6IzMzMzt9I2dyYXBoLWRpdiAuZXJyb3ItaWNvbntmaWxsOiM1NTIyMjI7fSNncmFwaC1kaXYgLmVycm9yLXRleHR7ZmlsbDojNTUyMjIyO3N0cm9rZTojNTUyMjIyO30jZ3JhcGgtZGl2IC5lZGdlLXRoaWNrbmVzcy1ub3JtYWx7c3Ryb2tlLXdpZHRoOjJweDt9I2dyYXBoLWRpdiAuZWRnZS10aGlja25lc3MtdGhpY2t7c3Ryb2tlLXdpZHRoOjMuNXB4O30jZ3JhcGgtZGl2IC5lZGdlLXBhdHRlcm4tc29saWR7c3Ryb2tlLWRhc2hhcnJheTowO30jZ3JhcGgtZGl2IC5lZGdlLXBhdHRlcm4tZGFzaGVke3N0cm9rZS1kYXNoYXJyYXk6Mzt9I2dyYXBoLWRpdiAuZWRnZS1wYXR0ZXJuLWRvdHRlZHtzdHJva2UtZGFzaGFycmF5OjI7fSNncmFwaC1kaXYgLm1hcmtlcntmaWxsOiMzMzMzMzM7c3Ryb2tlOiMzMzMzMzM7fSNncmFwaC1kaXYgLm1hcmtlci5jcm9zc3tzdHJva2U6IzMzMzMzMzt9I2dyYXBoLWRpdiBzdmd7Zm9udC1mYW1pbHk6InRyZWJ1Y2hldCBtcyIsdmVyZGFuYSxhcmlhbCxzYW5zLXNlcmlmO2ZvbnQtc2l6ZToxNnB4O30jZ3JhcGgtZGl2IC5lbnRpdHlCb3h7ZmlsbDojRUNFQ0ZGO3N0cm9rZTojOTM3MERCO30jZ3JhcGgtZGl2IC5hdHRyaWJ1dGVCb3hPZGR7ZmlsbDojZmZmZmZmO3N0cm9rZTojOTM3MERCO30jZ3JhcGgtZGl2IC5hdHRyaWJ1dGVCb3hFdmVue2ZpbGw6I2YyZjJmMjtzdHJva2U6IzkzNzBEQjt9I2dyYXBoLWRpdiAucmVsYXRpb25zaGlwTGFiZWxCb3h7ZmlsbDpoc2woODAsIDEwMCUsIDk2LjI3NDUwOTgwMzklKTtvcGFjaXR5OjAuNztiYWNrZ3JvdW5kLWNvbG9yOmhzbCg4MCwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpO30jZ3JhcGgtZGl2IC5yZWxhdGlvbnNoaXBMYWJlbEJveCByZWN0e29wYWNpdHk6MC41O30jZ3JhcGgtZGl2IC5yZWxhdGlvbnNoaXBMaW5le3N0cm9rZTojMzMzMzMzO30jZ3JhcGgtZGl2IDpyb290ey0tbWVybWFpZC1mb250LWZhbWlseToidHJlYnVjaGV0IG1zIix2ZXJkYW5hLGFyaWFsLHNhbnMtc2VyaWY7fTwvc3R5bGU+PGc+PC9nPjxkZWZzPjxtYXJrZXIgb3JpZW50PSJhdXRvIiBtYXJrZXJIZWlnaHQ9IjE4IiBtYXJrZXJXaWR0aD0iMTgiIHJlZlk9IjkiIHJlZlg9IjAiIGlkPSJPTkxZX09ORV9TVEFSVCI+PHBhdGggZD0iTTksMCBMOSwxOCBNMTUsMCBMMTUsMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iZ3JheSI+PC9wYXRoPjwvbWFya2VyPjwvZGVmcz48ZGVmcz48bWFya2VyIG9yaWVudD0iYXV0byIgbWFya2VySGVpZ2h0PSIxOCIgbWFya2VyV2lkdGg9IjE4IiByZWZZPSI5IiByZWZYPSIxOCIgaWQ9Ik9OTFlfT05FX0VORCI+PHBhdGggZD0iTTMsMCBMMywxOCBNOSwwIEw5LDE4IiBmaWxsPSJub25lIiBzdHJva2U9ImdyYXkiPjwvcGF0aD48L21hcmtlcj48L2RlZnM+PGRlZnM+PG1hcmtlciBvcmllbnQ9ImF1dG8iIG1hcmtlckhlaWdodD0iMTgiIG1hcmtlcldpZHRoPSIzMCIgcmVmWT0iOSIgcmVmWD0iMCIgaWQ9IlpFUk9fT1JfT05FX1NUQVJUIj48Y2lyY2xlIHI9IjYiIGN5PSI5IiBjeD0iMjEiIGZpbGw9IndoaXRlIiBzdHJva2U9ImdyYXkiPjwvY2lyY2xlPjxwYXRoIGQ9Ik05LDAgTDksMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iZ3JheSI+PC9wYXRoPjwvbWFya2VyPjwvZGVmcz48ZGVmcz48bWFya2VyIG9yaWVudD0iYXV0byIgbWFya2VySGVpZ2h0PSIxOCIgbWFya2VyV2lkdGg9IjMwIiByZWZZPSI5IiByZWZYPSIzMCIgaWQ9IlpFUk9fT1JfT05FX0VORCI+PGNpcmNsZSByPSI2IiBjeT0iOSIgY3g9IjkiIGZpbGw9IndoaXRlIiBzdHJva2U9ImdyYXkiPjwvY2lyY2xlPjxwYXRoIGQ9Ik0yMSwwIEwyMSwxOCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJncmF5Ij48L3BhdGg+PC9tYXJrZXI+PC9kZWZzPjxkZWZzPjxtYXJrZXIgb3JpZW50PSJhdXRvIiBtYXJrZXJIZWlnaHQ9IjM2IiBtYXJrZXJXaWR0aD0iNDUiIHJlZlk9IjE4IiByZWZYPSIxOCIgaWQ9Ik9ORV9PUl9NT1JFX1NUQVJUIj48cGF0aCBkPSJNMCwxOCBRIDE4LDAgMzYsMTggUSAxOCwzNiAwLDE4IE00Miw5IEw0MiwyNyIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJncmF5Ij48L3BhdGg+PC9tYXJrZXI+PC9kZWZzPjxkZWZzPjxtYXJrZXIgb3JpZW50PSJhdXRvIiBtYXJrZXJIZWlnaHQ9IjM2IiBtYXJrZXJXaWR0aD0iNDUiIHJlZlk9IjE4IiByZWZYPSIyNyIgaWQ9Ik9ORV9PUl9NT1JFX0VORCI+PHBhdGggZD0iTTMsOSBMMywyNyBNOSwxOCBRMjcsMCA0NSwxOCBRMjcsMzYgOSwxOCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJncmF5Ij48L3BhdGg+PC9tYXJrZXI+PC9kZWZzPjxkZWZzPjxtYXJrZXIgb3JpZW50PSJhdXRvIiBtYXJrZXJIZWlnaHQ9IjM2IiBtYXJrZXJXaWR0aD0iNTciIHJlZlk9IjE4IiByZWZYPSIxOCIgaWQ9IlpFUk9fT1JfTU9SRV9TVEFSVCI+PGNpcmNsZSByPSI2IiBjeT0iMTgiIGN4PSI0OCIgZmlsbD0id2hpdGUiIHN0cm9rZT0iZ3JheSI+PC9jaXJjbGU+PHBhdGggZD0iTTAsMTggUTE4LDAgMzYsMTggUTE4LDM2IDAsMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iZ3JheSI+PC9wYXRoPjwvbWFya2VyPjwvZGVmcz48ZGVmcz48bWFya2VyIG9yaWVudD0iYXV0byIgbWFya2VySGVpZ2h0PSIzNiIgbWFya2VyV2lkdGg9IjU3IiByZWZZPSIxOCIgcmVmWD0iMzkiIGlkPSJaRVJPX09SX01PUkVfRU5EIj48Y2lyY2xlIHI9IjYiIGN5PSIxOCIgY3g9IjkiIGZpbGw9IndoaXRlIiBzdHJva2U9ImdyYXkiPjwvY2lyY2xlPjxwYXRoIGQ9Ik0yMSwxOCBRMzksMCA1NywxOCBRMzksMzYgMjEsMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iZ3JheSI+PC9wYXRoPjwvbWFya2VyPjwvZGVmcz48cGF0aCBtYXJrZXItc3RhcnQ9InVybCgjWkVST19PUl9NT1JFX1NUQVJUKSIgbWFya2VyLWVuZD0idXJsKCNPTkxZX09ORV9FTkQpIiBmaWxsPSJub25lIiBzdHJva2U9ImdyYXkiIGQ9Ik03MCw4Nkw3MCw5NC4zMzMzMzMzMzMzMzMzM0M3MCwxMDIuNjY2NjY2NjY2NjY2NjcsNzAsMTE5LjMzMzMzMzMzMzMzMzMzLDcwLDEzNkM3MCwxNTIuNjY2NjY2NjY2NjY2NjYsNzAsMTY5LjMzMzMzMzMzMzMzMzM0LDcwLDE3Ny42NjY2NjY2NjY2NjY2Nkw3MCwxODYiIGNsYXNzPSJlciByZWxhdGlvbnNoaXBMaW5lIj48L3BhdGg+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjAsMTg2ICkiIGlkPSJCcmFuY2hlcyI+PHJlY3QgaGVpZ2h0PSI0NSIgd2lkdGg9IjEwMCIgeT0iMCIgeD0iMCIgc3Ryb2tlPSJncmF5IiBmaWxsLW9wYWNpdHk9IjEwMCUiIGZpbGw9ImhvbmV5ZGV3IiBjbGFzcz0iZXIgZW50aXR5Qm94Ij48L3JlY3Q+PHRleHQgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNTAsMTIpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEycHgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktQnJhbmNoZXMiIGNsYXNzPSJlciBlbnRpdHlMYWJlbCI+QnJhbmNoZXM8L3RleHQ+PHJlY3QgaGVpZ2h0PSIyMSIgd2lkdGg9IjMzLjY0NDcwNDE4Mjk0MjcxIiB5PSIyNCIgeD0iMCIgc3Ryb2tlPSJncmF5IiBmaWxsLW9wYWNpdHk9IjEwMCUiIGZpbGw9ImhvbmV5ZGV3IiBjbGFzcz0iZXIgYXR0cmlidXRlQm94T2RkIj48L3JlY3Q+PHRleHQgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNSwzNC41KSIgc3R5bGU9ImZvbnQtZmFtaWx5OiAmcXVvdDt0cmVidWNoZXQgbXMmcXVvdDssIHZlcmRhbmEsIGFyaWFsLCBzYW5zLXNlcmlmOzsgZm9udC1zaXplOiAxMC4ycHgiIHRleHQtYW5jaG9yPSJsZWZ0IiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB5PSIwIiB4PSIwIiBpZD0iZW50aXR5LUJyYW5jaGVzLWF0dHItMS10eXBlIiBjbGFzcz0iZXIgZW50aXR5TGFiZWwiPkludDwvdGV4dD48cmVjdCBoZWlnaHQ9IjIxIiB3aWR0aD0iMzAuNDExODI0NTQ0MjcwODM2IiB5PSIyNCIgeD0iMzMuNjQ0NzA0MTgyOTQyNzEiIHN0cm9rZT0iZ3JheSIgZmlsbC1vcGFjaXR5PSIxMDAlIiBmaWxsPSJob25leWRldyIgY2xhc3M9ImVyIGF0dHJpYnV0ZUJveE9kZCI+PC9yZWN0Pjx0ZXh0IHRyYW5zZm9ybT0idHJhbnNsYXRlKDM4LjY0NDcwNDE4Mjk0MjcxLDM0LjUpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEwLjJweCIgdGV4dC1hbmNob3I9ImxlZnQiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktQnJhbmNoZXMtYXR0ci0xLW5hbWUiIGNsYXNzPSJlciBlbnRpdHlMYWJlbCI+aWQ8L3RleHQ+PHJlY3QgaGVpZ2h0PSIyMSIgd2lkdGg9IjM1Ljk0MzQ3MTI3Mjc4NjQ2IiB5PSIyNCIgeD0iNjQuMDU2NTI4NzI3MjEzNTUiIHN0cm9rZT0iZ3JheSIgZmlsbC1vcGFjaXR5PSIxMDAlIiBmaWxsPSJob25leWRldyIgY2xhc3M9ImVyIGF0dHJpYnV0ZUJveE9kZCI+PC9yZWN0Pjx0ZXh0IHRyYW5zZm9ybT0idHJhbnNsYXRlKDY5LjA1NjUyODcyNzIxMzU1LDM0LjUpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEwLjJweCIgdGV4dC1hbmNob3I9ImxlZnQiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktQnJhbmNoZXMtYXR0ci0xLWtleSIgY2xhc3M9ImVyIGVudGl0eUxhYmVsIj5QSzwvdGV4dD48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjAsMjAgKSIgaWQ9IkxlYXZlcyI+PHJlY3QgaGVpZ2h0PSI2NiIgd2lkdGg9IjEwMCIgeT0iMCIgeD0iMCIgc3Ryb2tlPSJncmF5IiBmaWxsLW9wYWNpdHk9IjEwMCUiIGZpbGw9ImhvbmV5ZGV3IiBjbGFzcz0iZXIgZW50aXR5Qm94Ij48L3JlY3Q+PHRleHQgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNTAsMTIpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEycHgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktTGVhdmVzIiBjbGFzcz0iZXIgZW50aXR5TGFiZWwiPkxlYXZlczwvdGV4dD48cmVjdCBoZWlnaHQ9IjIxIiB3aWR0aD0iMzguNDcwMTQzNjM2MDY3NzEiIHk9IjI0IiB4PSIwIiBzdHJva2U9ImdyYXkiIGZpbGwtb3BhY2l0eT0iMTAwJSIgZmlsbD0iaG9uZXlkZXciIGNsYXNzPSJlciBhdHRyaWJ1dGVCb3hPZGQiPjwvcmVjdD48dGV4dCB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1LDM0LjUpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEwLjJweCIgdGV4dC1hbmNob3I9ImxlZnQiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktTGVhdmVzLWF0dHItMS10eXBlIiBjbGFzcz0iZXIgZW50aXR5TGFiZWwiPkludDwvdGV4dD48cmVjdCBoZWlnaHQ9IjIxIiB3aWR0aD0iMzYuMjExNzgxODE5NjYxNDYiIHk9IjI0IiB4PSIzOC40NzAxNDM2MzYwNjc3MSIgc3Ryb2tlPSJncmF5IiBmaWxsLW9wYWNpdHk9IjEwMCUiIGZpbGw9ImhvbmV5ZGV3IiBjbGFzcz0iZXIgYXR0cmlidXRlQm94T2RkIj48L3JlY3Q+PHRleHQgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNDMuNDcwMTQzNjM2MDY3NzEsMzQuNSkiIHN0eWxlPSJmb250LWZhbWlseTogJnF1b3Q7dHJlYnVjaGV0IG1zJnF1b3Q7LCB2ZXJkYW5hLCBhcmlhbCwgc2Fucy1zZXJpZjs7IGZvbnQtc2l6ZTogMTAuMnB4IiB0ZXh0LWFuY2hvcj0ibGVmdCIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgeT0iMCIgeD0iMCIgaWQ9ImVudGl0eS1MZWF2ZXMtYXR0ci0xLW5hbWUiIGNsYXNzPSJlciBlbnRpdHlMYWJlbCI+aWQ8L3RleHQ+PHJlY3QgaGVpZ2h0PSIyMSIgd2lkdGg9IjI1LjMxODA3NDU0NDI3MDgzMiIgeT0iMjQiIHg9Ijc0LjY4MTkyNTQ1NTcyOTE3IiBzdHJva2U9ImdyYXkiIGZpbGwtb3BhY2l0eT0iMTAwJSIgZmlsbD0iaG9uZXlkZXciIGNsYXNzPSJlciBhdHRyaWJ1dGVCb3hPZGQiPjwvcmVjdD48dGV4dCB0cmFuc2Zvcm09InRyYW5zbGF0ZSg3OS42ODE5MjU0NTU3MjkxNywzNC41KSIgc3R5bGU9ImZvbnQtZmFtaWx5OiAmcXVvdDt0cmVidWNoZXQgbXMmcXVvdDssIHZlcmRhbmEsIGFyaWFsLCBzYW5zLXNlcmlmOzsgZm9udC1zaXplOiAxMC4ycHgiIHRleHQtYW5jaG9yPSJsZWZ0IiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB5PSIwIiB4PSIwIiBpZD0iZW50aXR5LUxlYXZlcy1hdHRyLTEta2V5IiBjbGFzcz0iZXIgZW50aXR5TGFiZWwiPlBLPC90ZXh0PjxyZWN0IGhlaWdodD0iMjEiIHdpZHRoPSIzOC40NzAxNDM2MzYwNjc3MSIgeT0iNDUiIHg9IjAiIHN0cm9rZT0iZ3JheSIgZmlsbC1vcGFjaXR5PSIxMDAlIiBmaWxsPSJob25leWRldyIgY2xhc3M9ImVyIGF0dHJpYnV0ZUJveEV2ZW4iPjwvcmVjdD48dGV4dCB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1LDU1LjUpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEwLjJweCIgdGV4dC1hbmNob3I9ImxlZnQiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktTGVhdmVzLWF0dHItMi10eXBlIiBjbGFzcz0iZXIgZW50aXR5TGFiZWwiPlN0cmluZzwvdGV4dD48cmVjdCBoZWlnaHQ9IjIxIiB3aWR0aD0iMzYuMjExNzgxODE5NjYxNDYiIHk9IjQ1IiB4PSIzOC40NzAxNDM2MzYwNjc3MSIgc3Ryb2tlPSJncmF5IiBmaWxsLW9wYWNpdHk9IjEwMCUiIGZpbGw9ImhvbmV5ZGV3IiBjbGFzcz0iZXIgYXR0cmlidXRlQm94RXZlbiI+PC9yZWN0Pjx0ZXh0IHRyYW5zZm9ybT0idHJhbnNsYXRlKDQzLjQ3MDE0MzYzNjA2NzcxLDU1LjUpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEwLjJweCIgdGV4dC1hbmNob3I9ImxlZnQiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktTGVhdmVzLWF0dHItMi1uYW1lIiBjbGFzcz0iZXIgZW50aXR5TGFiZWwiPnZhbHVlPC90ZXh0PjxyZWN0IGhlaWdodD0iMjEiIHdpZHRoPSIyNS4zMTgwNzQ1NDQyNzA4MzIiIHk9IjQ1IiB4PSI3NC42ODE5MjU0NTU3MjkxNyIgc3Ryb2tlPSJncmF5IiBmaWxsLW9wYWNpdHk9IjEwMCUiIGZpbGw9ImhvbmV5ZGV3IiBjbGFzcz0iZXIgYXR0cmlidXRlQm94RXZlbiI+PC9yZWN0Pjx0ZXh0IHRyYW5zZm9ybT0idHJhbnNsYXRlKDc5LjY4MTkyNTQ1NTcyOTE3LDU1LjUpIiBzdHlsZT0iZm9udC1mYW1pbHk6ICZxdW90O3RyZWJ1Y2hldCBtcyZxdW90OywgdmVyZGFuYSwgYXJpYWwsIHNhbnMtc2VyaWY7OyBmb250LXNpemU6IDEwLjJweCIgdGV4dC1hbmNob3I9ImxlZnQiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHk9IjAiIHg9IjAiIGlkPSJlbnRpdHktTGVhdmVzLWF0dHItMi1rZXkiIGNsYXNzPSJlciBlbnRpdHlMYWJlbCI+PC90ZXh0PjwvZz48cmVjdCBmaWxsLW9wYWNpdHk9Ijg1JSIgZmlsbD0id2hpdGUiIGhlaWdodD0iMTQiIHdpZHRoPSIzNi43MDMxMjUiIHk9IjEyOSIgeD0iNTEuNjQ4NDM3NSIgY2xhc3M9ImVyIHJlbGF0aW9uc2hpcExhYmVsQm94Ij48L3JlY3Q+PHRleHQgc3R5bGU9ImZvbnQtZmFtaWx5OiAmcXVvdDt0cmVidWNoZXQgbXMmcXVvdDssIHZlcmRhbmEsIGFyaWFsLCBzYW5zLXNlcmlmOzsgZm9udC1zaXplOiAxMnB4IiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB5PSIxMzYiIHg9IjcwIiBpZD0icmVsMTIiIGNsYXNzPSJlciByZWxhdGlvbnNoaXBMYWJlbCI+YnJhbmNoPC90ZXh0Pjwvc3ZnPg==" title="単純な1:NのER図" width="140" height="251" class="img_ev3q"></p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>schema.prisma</summary><div><div class="collapsibleContent_i85q"><div class="language-prisma codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-prisma codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">generator client {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provider = &quot;prisma-client-js&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">datasource db {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provider = &quot;sqlite&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  url      = env(&quot;DATABASE_URL&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model Branches {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id     Int      @id @default(autoincrement())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  leaves Leaves[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model Leaves {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id       Int      @id @default(autoincrement())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  branch   Branches @relation(fields: [branchId], references: [id])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  branchId Int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value    String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>上図の単純な <code>Branches</code>:<code>Leaves</code> = 1:N となるテーブルに対して、Prisma で取得したオブジェクトに対し、</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">branches</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">leaves</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;hoge&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;huga&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>のようにプロパティアクセスで子となるレコードの値のみを取得したい。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="実際の挙動">実際の挙動<a class="hash-link" href="#実際の挙動" title="この見出しへのリンク">​</a></h2><p>Prisma ではレコードはオブジェクトとなる。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> branch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> prisma</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">branches</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findFirstOrThrow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> leaves</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> branch</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>とすると下記のような形でレコードが返される。</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;leaves&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;branchId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;hoge&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;branchId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;huga&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="proxy-を利用したルーティング">Proxy を利用したルーティング<a class="hash-link" href="#proxy-を利用したルーティング" title="この見出しへのリンク">​</a></h2><p><code>leaves</code>に対するアクセスを下記のように処理すると値の配列として取得できる。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ILeaf</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">IBranch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  leaves</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Array</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ILeaf</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> proxy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ProxyHandler</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">IBranch</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">get</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prop </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;leaves&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">leaves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">leaf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> leaf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Object</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hasOwn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">prop </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">keyof</span><span class="token plain"> IBranch</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> branch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> prisma</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">branches</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findFirstOrThrow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> leaves</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Proxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">branch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> proxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>leaves</code>は単純な値の配列となる。</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;leaves&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;hoge&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;huga&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="留意点">留意点<a class="hash-link" href="#留意点" title="この見出しへのリンク">​</a></h2><p>プロパティをプライベートにするものではないため、値の更新をする場合には注意が必要。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> records </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;secret&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;keys&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> proxy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">get</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">obj</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prop </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;private&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">prop</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">record</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">prop</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> proxied </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Proxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">records</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> proxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">proxied</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">private</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// &gt; [ { id: 0, value: &#x27;secret&#x27; }, { id: 1, value: &#x27;keys&#x27; } ]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proxied</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">private</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;hoge&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;huga&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">proxied</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">private</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// &gt; [ undefined, undefined ]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>タグ:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/javascript">javascript</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/prisma">prisma</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/2022/07/18/duplicated-value-in-set">【JavaScript】プリミティブでない値を持つSetにて重複が発生する</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-07-18T00:00:00.000Z" itemprop="datePublished">2022年7月18日</time> · <!-- -->約5分</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ogumaru" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ogumaru.png" alt="ogumaru"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ogumaru" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">ogumaru</span></a></div><small class="avatar__subtitle" itemprop="description">ogumaru note owner</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a class="hash-link" href="#概要" title="この見出しへのリンク">​</a></h2><p>TypeScript にて、タプル風(<code>[T, T]</code>)の配列のコレクションがあり、これの中身をユニークにしたい場面があった。</p><p><code>Set</code>を経由すれば重複排除できると思ったが、見た目上同じオブジェクトの重複は排除されなかった。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="結論">結論<a class="hash-link" href="#結論" title="この見出しへのリンク">​</a></h2><p>JavaScript における配列の同値比較が<code>false</code>になるため。</p><p>厳密にユニークなコレクションを作成する場合は、deepEqual 相当の確認が必要そう。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="実行環境">実行環境<a class="hash-link" href="#実行環境" title="この見出しへのリンク">​</a></h2><table><thead><tr><th>実行環境</th><th>バージョン</th></tr></thead><tbody><tr><td>node</td><td>v16.15.0</td></tr><tr><td>python3</td><td>Python 3.10.4</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="javascript-の挙動と-python-との比較">JavaScript の挙動と Python との比較<a class="hash-link" href="#javascript-の挙動と-python-との比較" title="この見出しへのリンク">​</a></h2><p>タプル風の配列リテラルを<code>add</code>すると、重複した値がそれぞれが追加されてしまう。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> unique </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;hoge&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;huga&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Set(1) { [ &#x27;hoge&#x27;, &#x27;huga&#x27; ] }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;hoge&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;huga&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Set(2) { [ &#x27;hoge&#x27;, &#x27;huga&#x27; ], [ &#x27;hoge&#x27;, &#x27;huga&#x27; ] }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Python ではできた気がしたので確認する。</p><p>(なお<code>[&quot;hoge&quot;, &quot;huga&quot;]</code>は<code>Hashable</code>でないため<code>set</code>には追加できない)</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">unique </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;hoge&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;huga&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># {(&#x27;hoge&#x27;, &#x27;huga&#x27;)}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;hoge&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;huga&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># {(&#x27;hoge&#x27;, &#x27;huga&#x27;)}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>リテラルのタプルに対して重複排除ができている。</p><p>JavaScript でも、オブジェクトが同一になるため、下記では意図した通りに重複が排除される。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> unique </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> tuple </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;hoge&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;huga&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tuple</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Set(1) { [ &#x27;hoge&#x27;, &#x27;huga&#x27; ] }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tuple</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Set(1) { [ &#x27;hoge&#x27;, &#x27;huga&#x27; ] }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>JavaScript では Python におけるタプル相当のデータ型がないため、上記コードでは実際にはミュータブルな配列となる。</p><p><code>Object.freeze()</code>でイミュータブルにしてみたが、結果は変わらなかった。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> unique </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token known-class-name class-name">Object</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">freeze</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;hoge&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;huga&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Set(1) { [ &#x27;hoge&#x27;, &#x27;huga&#x27; ] }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token known-class-name class-name">Object</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">freeze</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;hoge&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;huga&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Set(2) { [ &#x27;hoge&#x27;, &#x27;huga&#x27; ], [ &#x27;hoge&#x27;, &#x27;huga&#x27; ] }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="仕様の確認">仕様の確認<a class="hash-link" href="#仕様の確認" title="この見出しへのリンク">​</a></h2><p>MDN の<code>Set</code>のページを見ると、<code>-0</code>と<code>+0</code>について触れられている。</p><blockquote><p>See &quot;Key equality for -0 and 0&quot; in the browser compatibility table for details.</p></blockquote><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set#value_equality" target="_blank" rel="noopener noreferrer">Set - JavaScript | MDN (developer.mozilla.org)</a></p><p>等価比較のページを見ると、</p><blockquote><p>SameValueZero: used by %TypedArray% and ArrayBuffer constructors, as well as Map and Set operations, and also String.prototype.includes and Array.prototype.includes since ES2016</p></blockquote><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Equality_comparisons_and_sameness" target="_blank" rel="noopener noreferrer">Equality comparisons and sameness - JavaScript | MDN (developer.mozilla.org)</a></p><p><code>SameValueZero</code>の TC39 へリンクされていたのでこちらも確認。</p><blockquote><p>SameValueZero differs from SameValue only in that it treats +0𝔽 and -0𝔽 as equivalent.</p></blockquote><p><a href="https://tc39.es/ecma262/#sec-samevaluezero" target="_blank" rel="noopener noreferrer">SameValueZero | ECMAScript® 2023 Language Specification (tc39.es)</a></p><p><code>SameValue</code>と<code>+0</code>と<code>-0</code>の比較結果のみ異なるとあるため、<a href="https://tc39.es/ecma262/#sec-samevalue" target="_blank" rel="noopener noreferrer"><code>SameValue</code></a>を確認すると、</p><blockquote><ol><li><p>If Type(x) is different from Type(y), return false.</p></li><li><p>If Type(x) is Number, then</p><p>a. Return Number::sameValue(x, y).</p></li><li><p>If Type(x) is BigInt, then</p><p>a. Return BigInt::sameValue(x, y).</p></li><li><p>Return SameValueNonNumeric(x, y).</p></li></ol></blockquote><p>とのことなので<a href="https://tc39.es/ecma262/#sec-samevaluenonnumeric" target="_blank" rel="noopener noreferrer"><code>SameValueNonNumeric</code></a>を確認。</p><blockquote><ol><li><p>Assert: Type(x) is the same as Type(y).</p></li><li><p>If Type(x) is Undefined, return true.</p></li><li><p>If Type(x) is Null, return true.</p></li><li><p>If Type(x) is String, then</p><p>a. If x and y are exactly the same sequence of code units (same length and same code units at corresponding indices), return true; otherwise, return false.</p></li><li><p>If Type(x) is Boolean, then</p><p>a. If x and y are both true or both false, return true; otherwise, return false.</p></li><li><p>If Type(x) is Symbol, then</p><p>a. If x and y are both the same Symbol value, return true; otherwise, return false.</p></li><li><p>If x and y are the same Object value, return true. Otherwise, return false.</p></li></ol></blockquote><p>タプルの場合<code>7</code>にて評価されると思われ、<code>same Object value</code>ではないということになるようだ。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="same-object-value-とは">same Object value とは<a class="hash-link" href="#same-object-value-とは" title="この見出しへのリンク">​</a></h2><p>TC39にはこれ以上のリンクがなかったが、deepEqual相当の比較を行うことで重複の確認はできそう。</p><p>修正 PR いただけるとありがたいです。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>タグ:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/javascript">javascript</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/python">python</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="ブログ記事一覧のナビゲーション"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c1986dcc.js"></script>
<script src="/assets/js/main.46051f0f.js"></script>
</body>
</html>